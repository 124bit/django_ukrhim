var JSC3D=JSC3D||{};JSC3D.Viewer=function(canvas,parameters){if(parameters)
this.params={SceneUrl:parameters.SceneUrl||'',InitRotationX:parameters.InitRotationX||0,InitRotationY:parameters.InitRotationY||0,InitRotationZ:parameters.InitRotationZ||0,ModelColor:parameters.ModelColor||'#caa618',BackgroundColor1:parameters.BackgroundColor1||'#ffffff',BackgroundColor2:parameters.BackgroundColor2||'#383840',BackgroundImageUrl:parameters.BackgroundImageUrl||'',RenderMode:parameters.RenderMode||'flat',Definition:parameters.Definition||'standard',MipMapping:parameters.MipMapping||'off',CreaseAngle:parameters.parameters||-180,SphereMapUrl:parameters.SphereMapUrl||'',ProgressBar:parameters.ProgressBar||'on',Renderer:parameters.Renderer||'',LocalBuffers:parameters.LocalBuffers||'retain'};else
this.params={SceneUrl:'',InitRotationX:0,InitRotationY:0,InitRotationZ:0,ModelColor:'#caa618',BackgroundColor1:'#ffffff',BackgroundColor2:'#383840',BackgroundImageUrl:'',RenderMode:'flat',Definition:'standard',MipMapping:'off',CreaseAngle:-180,SphereMapUrl:'',ProgressBar:'on',Renderer:'',LocalBuffers:'retain'};this.canvas=canvas;this.ctx2d=null;this.canvasData=null;this.bkgColorBuffer=null;this.colorBuffer=null;this.zBuffer=null;this.selectionBuffer=null;this.frameWidth=canvas.width;this.frameHeight=canvas.height;this.scene=null;this.defaultMaterial=null;this.sphereMap=null;this.isLoaded=false;this.isFailed=false;this.abortUnfinishedLoadingFn=null;this.needUpdate=false;this.needRepaint=false;this.initRotX=0;this.initRotY=0;this.initRotZ=0;this.zoomFactor=1;this.panning=[0,0];this.rotMatrix=new JSC3D.Matrix3x4;this.transformMatrix=new JSC3D.Matrix3x4;this.sceneUrl='';this.modelColor=0xcaa618;this.bkgColor1=0xffffff;this.bkgColor2=0x383840;this.bkgImageUrl='';this.bkgImage=null;this.renderMode='flat';this.definition='standard';this.isMipMappingOn=false;this.creaseAngle=-180;this.sphereMapUrl='';this.showProgressBar=true;this.buttonStates={};this.keyStates={};this.mouseX=0;this.mouseY=0;this.isTouchHeld=false;this.baseZoomFactor=1;this.onloadingstarted=null;this.onloadingcomplete=null;this.onloadingprogress=null;this.onloadingaborted=null;this.onloadingerror=null;this.onmousedown=null;this.onmouseup=null;this.onmousemove=null;this.onmousewheel=null;this.beforeupdate=null;this.afterupdate=null;this.mouseUsage='default';this.isDefaultInputHandlerEnabled=true;this.progressFrame=null;this.progressRectangle=null;this.messagePanel=null;this.webglBackend=null;var self=this;if(!JSC3D.PlatformInfo.isTouchDevice){this.canvas.addEventListener('mousedown',function(e){self.mouseDownHandler(e);},false);this.canvas.addEventListener('mouseup',function(e){self.mouseUpHandler(e);},false);this.canvas.addEventListener('mousemove',function(e){self.mouseMoveHandler(e);},false);this.canvas.addEventListener(JSC3D.PlatformInfo.browser=='firefox'?'DOMMouseScroll':'mousewheel',function(e){self.mouseWheelHandler(e);},false);document.addEventListener('keydown',function(e){self.keyDownHandler(e);},false);document.addEventListener('keyup',function(e){self.keyUpHandler(e);},false);}
else if(JSC3D.Hammer){JSC3D.Hammer(this.canvas).on('touch release hold drag pinch',function(e){self.gestureHandler(e);});}
else{this.canvas.addEventListener('touchstart',function(e){self.touchStartHandler(e);},false);this.canvas.addEventListener('touchend',function(e){self.touchEndHandler(e);},false);this.canvas.addEventListener('touchmove',function(e){self.touchMoveHandler(e);},false);}};JSC3D.Viewer.prototype.setParameter=function(name,value){this.params[name]=value;};JSC3D.Viewer.prototype.init=function(){this.sceneUrl=this.params['SceneUrl'];this.initRotX=parseFloat(this.params['InitRotationX']);this.initRotY=parseFloat(this.params['InitRotationY']);this.initRotZ=parseFloat(this.params['InitRotationZ']);this.modelColor=parseInt('0x'+this.params['ModelColor'].substring(1));this.bkgColor1=parseInt('0x'+this.params['BackgroundColor1'].substring(1));this.bkgColor2=parseInt('0x'+this.params['BackgroundColor2'].substring(1));this.bkgImageUrl=this.params['BackgroundImageUrl'];this.renderMode=this.params['RenderMode'].toLowerCase();this.definition=this.params['Definition'].toLowerCase();this.creaseAngle=parseFloat(this.params['CreaseAngle']);this.isMipMappingOn=this.params['MipMapping'].toLowerCase()=='on';this.sphereMapUrl=this.params['SphereMapUrl'];this.showProgressBar=this.params['ProgressBar'].toLowerCase()=='on';this.useWebGL=this.params['Renderer'].toLowerCase()=='webgl';this.releaseLocalBuffers=this.params['LocalBuffers'].toLowerCase()=='release';if(this.useWebGL&&JSC3D.PlatformInfo.supportWebGL&&JSC3D.WebGLRenderBackend){try{this.webglBackend=new JSC3D.WebGLRenderBackend(this.canvas,this.releaseLocalBuffers);}catch(e){}}
if(!this.webglBackend){if(this.useWebGL){if(JSC3D.console)
JSC3D.console.logWarning('WebGL is not available. Software rendering is enabled instead.');}
try{this.ctx2d=this.canvas.getContext('2d');this.canvasData=this.ctx2d.getImageData(0,0,this.canvas.width,this.canvas.height);}
catch(e){this.ctx2d=null;this.canvasData=null;}}
if(this.canvas.width<=2||this.canvas.height<=2)
this.definition='standard';switch(this.definition){case'low':this.frameWidth=~~((this.canvas.width+1)/2);this.frameHeight=~~((this.canvas.height+1)/2);break;case'high':this.frameWidth=this.canvas.width*2;this.frameHeight=this.canvas.height*2;break;case'standard':default:this.frameWidth=this.canvas.width;this.frameHeight=this.canvas.height;break;}
this.zoomFactor=1;this.panning=[0,0];this.rotMatrix.identity();this.transformMatrix.identity();this.isLoaded=false;this.isFailed=false;this.needUpdate=false;this.needRepaint=false;this.scene=null;this.defaultMaterial=new JSC3D.Material;this.defaultMaterial.ambientColor=0;this.defaultMaterial.diffuseColor=this.modelColor;this.defaultMaterial.transparency=0;this.defaultMaterial.simulateSpecular=true;if(!this.webglBackend){this.colorBuffer=new Array(this.frameWidth*this.frameHeight);this.zBuffer=new Array(this.frameWidth*this.frameHeight);this.selectionBuffer=new Array(this.frameWidth*this.frameHeight);this.bkgColorBuffer=new Array(this.frameWidth*this.frameHeight);}
this.generateBackground();this.drawBackground();var self=this;(function tick(){self.doUpdate();setTimeout(tick,30);})();this.setBackgroudImageFromUrl(this.bkgImageUrl);this.loadScene();this.setSphereMapFromUrl(this.sphereMapUrl);};JSC3D.Viewer.prototype.update=function(repaintOnly){if(this.isFailed)
return;if(repaintOnly)
this.needRepaint=true;else
this.needUpdate=true;};JSC3D.Viewer.prototype.rotate=function(rotX,rotY,rotZ){this.rotMatrix.rotateAboutXAxis(rotX);this.rotMatrix.rotateAboutYAxis(rotY);this.rotMatrix.rotateAboutZAxis(rotZ);};JSC3D.Viewer.prototype.setRenderMode=function(mode){this.params['RenderMode']=mode;this.renderMode=mode;};JSC3D.Viewer.prototype.setDefinition=function(definition){if(this.canvas.width<=2||this.canvas.height<=2)
definition='standard';if(definition==this.definition)
return;this.params['Definition']=definition;this.definition=definition;var oldFrameWidth=this.frameWidth;switch(this.definition){case'low':this.frameWidth=~~((this.canvas.width+1)/2);this.frameHeight=~~((this.canvas.height+1)/2);break;case'high':this.frameWidth=this.canvas.width*2;this.frameHeight=this.canvas.height*2;break;case'standard':default:this.frameWidth=this.canvas.width;this.frameHeight=this.canvas.height;break;}
var ratio=this.frameWidth/oldFrameWidth;this.zoomFactor*=ratio;this.panning[0]*=ratio;this.panning[1]*=ratio;if(this.webglBackend)
return;var newSize=this.frameWidth*this.frameHeight;if(this.colorBuffer.length<newSize)
this.colorBuffer=new Array(newSize);if(this.zBuffer.length<newSize)
this.zBuffer=new Array(newSize);if(this.selectionBuffer.length<newSize)
this.selectionBuffer=new Array(newSize);if(this.bkgColorBuffer.length<newSize)
this.bkgColorBuffer=new Array(newSize);this.generateBackground();};JSC3D.Viewer.prototype.setBackgroudImageFromUrl=function(backgroundImageUrl){this.params['BackgroundImageUrl']=backgroundImageUrl;this.bkgImageUrl=backgroundImageUrl;if(backgroundImageUrl==''){this.bkgImage=null;return;}
var self=this;var img=new Image;img.onload=function(){self.bkgImage=this;self.generateBackground();};img.src=backgroundImageUrl;};JSC3D.Viewer.prototype.setSphereMapFromUrl=function(sphereMapUrl){this.params['SphereMapUrl']=sphereMapUrl;this.sphereMapUrl=sphereMapUrl;if(sphereMapUrl==''){this.sphereMap=null;return;}
var self=this;var newMap=new JSC3D.Texture;newMap.onready=function(){self.sphereMap=newMap;self.update();};newMap.createFromUrl(this.sphereMapUrl);};JSC3D.Viewer.prototype.enableDefaultInputHandler=function(enabled){this.isDefaultInputHandlerEnabled=enabled;};JSC3D.Viewer.prototype.setMouseUsage=function(usage){this.mouseUsage=usage;};JSC3D.Viewer.prototype.isWebGLEnabled=function(){return this.webglBackend!=null;};JSC3D.Viewer.prototype.replaceSceneFromUrl=function(sceneUrl){this.params['SceneUrl']=sceneUrl;this.sceneUrl=sceneUrl;this.isFailed=this.isLoaded=false;this.loadScene();};JSC3D.Viewer.prototype.replaceScene=function(scene){this.params['SceneUrl']='';this.sceneUrl='';this.isFailed=false;this.isLoaded=true;this.setupScene(scene);};JSC3D.Viewer.prototype.resetScene=function(){var d=(!this.scene||this.scene.isEmpty())?0:this.scene.aabb.lengthOfDiagonal();this.zoomFactor=(d==0)?1:(this.frameWidth<this.frameHeight?this.frameWidth:this.frameHeight)/d;this.panning=[0,0];this.rotMatrix.identity();this.rotMatrix.rotateAboutXAxis(this.initRotX);this.rotMatrix.rotateAboutYAxis(this.initRotY);this.rotMatrix.rotateAboutZAxis(this.initRotZ);};JSC3D.Viewer.prototype.getScene=function(){return this.scene;};JSC3D.Viewer.prototype.pick=function(clientX,clientY){var pickInfo=new JSC3D.PickInfo;var canvasRect=this.canvas.getBoundingClientRect();var canvasX=clientX-canvasRect.left;var canvasY=clientY-canvasRect.top;pickInfo.canvasX=canvasX;pickInfo.canvasY=canvasY;var pickedId=0;if(this.webglBackend){pickedId=this.webglBackend.pick(canvasX,canvasY);}
else{var frameX=canvasX;var frameY=canvasY;if(this.selectionBuffer!=null&&canvasX>=0&&canvasX<this.canvas.width&&canvasY>=0&&canvasY<this.canvas.height){switch(this.definition){case'low':frameX=~~(frameX/2);frameY=~~(frameY/2);break;case'high':frameX*=2;frameY*=2;break;case'standard':default:break;}
pickedId=this.selectionBuffer[frameY*this.frameWidth+frameX];if(pickedId>0)
pickInfo.depth=this.zBuffer[frameY*this.frameWidth+frameX];}}
if(pickedId>0){var meshes=this.scene.getChildren();for(var i=0;i<meshes.length;i++){if(meshes[i].internalId==pickedId){pickInfo.mesh=meshes[i];break;}}}
return pickInfo;};JSC3D.Viewer.prototype.doUpdate=function(){if(this.needUpdate||this.needRepaint){if(this.beforeupdate!=null&&(typeof this.beforeupdate)=='function')
this.beforeupdate();if(this.scene){if(this.needUpdate){this.beginScene();this.render();this.endScene();}
this.paint();}
else{this.drawBackground();}
this.needRepaint=false;this.needUpdate=false;if(this.afterupdate!=null&&(typeof this.afterupdate)=='function')
this.afterupdate();}};JSC3D.Viewer.prototype.paint=function(){if(this.webglBackend||!this.ctx2d)
return;this.ctx2d.putImageData(this.canvasData,0,0);};JSC3D.Viewer.prototype.mouseDownHandler=function(e){if(!this.isLoaded)
return;if(this.onmousedown){var info=this.pick(e.clientX,e.clientY);this.onmousedown(info.canvasX,info.canvasY,e.button,info.depth,info.mesh);}
e.preventDefault();e.stopPropagation();if(!this.isDefaultInputHandlerEnabled)
return;this.buttonStates[e.button]=true;this.mouseX=e.clientX;this.mouseY=e.clientY;};JSC3D.Viewer.prototype.mouseUpHandler=function(e){if(!this.isLoaded)
return;if(this.onmouseup){var info=this.pick(e.clientX,e.clientY);this.onmouseup(info.canvasX,info.canvasY,e.button,info.depth,info.mesh);}
e.preventDefault();e.stopPropagation();if(!this.isDefaultInputHandlerEnabled)
return;this.buttonStates[e.button]=false;};JSC3D.Viewer.prototype.mouseMoveHandler=function(e){if(!this.isLoaded)
return;if(this.onmousemove){var info=this.pick(e.clientX,e.clientY);this.onmousemove(info.canvasX,info.canvasY,e.button,info.depth,info.mesh);}
e.preventDefault();e.stopPropagation();if(!this.isDefaultInputHandlerEnabled)
return;var isDragging=this.buttonStates[0]==true;var isShiftDown=this.keyStates[0x10]==true;var isCtrlDown=this.keyStates[0x11]==true;if(isDragging){if((isShiftDown&&this.mouseUsage=='default')||this.mouseUsage=='zoom'){this.zoomFactor*=this.mouseY<=e.clientY?1.04:0.96;}
else if((isCtrlDown&&this.mouseUsage=='default')||this.mouseUsage=='pan'){var ratio=(this.definition=='low')?0.5:((this.definition=='high')?2:1);this.panning[0]+=ratio*(e.clientX-this.mouseX);this.panning[1]+=ratio*(e.clientY-this.mouseY);}
else if(this.mouseUsage=='default'||this.mouseUsage=='rotate'){var rotX=(e.clientY-this.mouseY)*360/this.canvas.width;var rotY=(e.clientX-this.mouseX)*360/this.canvas.height;this.rotMatrix.rotateAboutXAxis(rotX);this.rotMatrix.rotateAboutYAxis(rotY);}
this.mouseX=e.clientX;this.mouseY=e.clientY;this.update();}};JSC3D.Viewer.prototype.mouseWheelHandler=function(e){if(!this.isLoaded)
return;if(this.onmousewheel){var info=this.pick(e.clientX,e.clientY);this.onmousewheel(info.canvasX,info.canvasY,e.button,info.depth,info.mesh);}
e.preventDefault();e.stopPropagation();if(!this.isDefaultInputHandlerEnabled)
return;this.zoomFactor*=(JSC3D.PlatformInfo.browser=='firefox'?-e.detail:e.wheelDelta)<0?1.1:0.91;this.update();};JSC3D.Viewer.prototype.touchStartHandler=function(e){if(!this.isLoaded)
return;if(e.touches.length>0){var clientX=e.touches[0].clientX;var clientY=e.touches[0].clientY;if(this.onmousedown){var info=this.pick(clientX,clientY);this.onmousedown(info.canvasX,info.canvasY,0,info.depth,info.mesh);}
e.preventDefault();e.stopPropagation();if(!this.isDefaultInputHandlerEnabled)
return;this.buttonStates[0]=true;this.mouseX=clientX;this.mouseY=clientY;}};JSC3D.Viewer.prototype.touchEndHandler=function(e){if(!this.isLoaded)
return;if(this.onmouseup){var info=this.pick(this.mouseX,this.mouseY);this.onmouseup(info.canvasX,info.canvasY,0,info.depth,info.mesh);}
e.preventDefault();e.stopPropagation();if(!this.isDefaultInputHandlerEnabled)
return;this.buttonStates[0]=false;};JSC3D.Viewer.prototype.touchMoveHandler=function(e){if(!this.isLoaded)
return;if(e.touches.length>0){var clientX=e.touches[0].clientX;var clientY=e.touches[0].clientY;if(this.onmousemove){var info=this.pick(clientX,clientY);this.onmousemove(info.canvasX,info.canvasY,0,info.depth,info.mesh);}
e.preventDefault();e.stopPropagation();if(!this.isDefaultInputHandlerEnabled)
return;if(this.mouseUsage=='zoom'){this.zoomFactor*=(this.mouseY<=clientY)?1.04:0.96;}
else if(this.mouseUsage=='pan'){var ratio=(this.definition=='low')?0.5:((this.definition=='high')?2:1);this.panning[0]+=ratio*(clientX-this.mouseX);this.panning[1]+=ratio*(clientY-this.mouseY);}
else if(this.mouseUsage=='default'||this.mouseUsage=='rotate'){var rotX=(clientY-this.mouseY)*360/this.canvas.width;var rotY=(clientX-this.mouseX)*360/this.canvas.height;this.rotMatrix.rotateAboutXAxis(rotX);this.rotMatrix.rotateAboutYAxis(rotY);}
this.mouseX=clientX;this.mouseY=clientY;this.update();}};JSC3D.Viewer.prototype.keyDownHandler=function(e){if(!this.isDefaultInputHandlerEnabled)
return;this.keyStates[e.keyCode]=true;};JSC3D.Viewer.prototype.keyUpHandler=function(e){if(!this.isDefaultInputHandlerEnabled)
return;this.keyStates[e.keyCode]=false;};JSC3D.Viewer.prototype.gestureHandler=function(e){if(!this.isLoaded)
return;var clientX=e.gesture.center.pageX-document.body.scrollLeft;var clientY=e.gesture.center.pageY-document.body.scrollTop;var info=this.pick(clientX,clientY);switch(e.type){case'touch':if(this.onmousedown)
this.onmousedown(info.canvasX,info.canvasY,0,info.depth,info.mesh);this.baseZoomFactor=this.zoomFactor;this.mouseX=clientX;this.mouseY=clientY;break;case'release':if(this.onmouseup)
this.onmouseup(info.canvasX,info.canvasY,0,info.depth,info.mesh);this.isTouchHeld=false;break;case'hold':this.isTouchHeld=true;break;case'drag':if(this.onmousemove)
this.onmousemove(info.canvasX,info.canvasY,0,info.depth,info.mesh);if(!this.isDefaultInputHandlerEnabled)
break;if(this.isTouchHeld){var ratio=(this.definition=='low')?0.5:((this.definition=='high')?2:1);this.panning[0]+=ratio*(clientX-this.mouseX);this.panning[1]+=ratio*(clientY-this.mouseY);}
else{var rotX=(clientY-this.mouseY)*360/this.canvas.width;var rotY=(clientX-this.mouseX)*360/this.canvas.height;this.rotMatrix.rotateAboutXAxis(rotX);this.rotMatrix.rotateAboutYAxis(rotY);}
this.mouseX=clientX;this.mouseY=clientY;this.update();break;case'pinch':if(this.onmousewheel)
this.onmousewheel(info.canvasX,info.canvasY,0,info.depth,info.mesh);if(!this.isDefaultInputHandlerEnabled)
break;this.zoomFactor=this.baseZoomFactor*e.gesture.scale;this.update();break;default:break;}
e.gesture.preventDefault();e.gesture.stopPropagation();};JSC3D.Viewer.prototype.loadScene=function(){if(this.abortUnfinishedLoadingFn)
this.abortUnfinishedLoadingFn();this.scene=null;this.isLoaded=false;this.update();if(this.sceneUrl=='')
return false;var lastSlashAt=this.sceneUrl.lastIndexOf('/');if(lastSlashAt==-1)
lastSlashAt=this.sceneUrl.lastIndexOf('\\');var fileName=this.sceneUrl.substring(lastSlashAt+1);var lastDotAt=fileName.lastIndexOf('.');if(lastDotAt==-1){if(JSC3D.console)
JSC3D.console.logError('Cannot get file format for the lack of file extension.');return false;}
var fileExtName=fileName.substring(lastDotAt+1);var loader=JSC3D.LoaderSelector.getLoader(fileExtName);if(!loader){if(JSC3D.console)
JSC3D.console.logError('Unknown file format: "'+fileExtName+'".');return false;}
var self=this;loader.onload=function(scene){self.abortUnfinishedLoadingFn=null;self.setupScene(scene);if(self.onloadingcomplete&&(typeof self.onloadingcomplete)=='function')
self.onloadingcomplete();};loader.onerror=function(errorMsg){self.scene=null;self.isLoaded=false;self.isFailed=true;self.abortUnfinishedLoadingFn=null;self.update();self.reportError(errorMsg);if(self.onloadingerror&&(typeof self.onloadingerror)=='function')
self.onloadingerror(errorMsg);};loader.onprogress=function(task,prog){if(self.showProgressBar)
self.reportProgress(task,prog);if(self.onloadingprogress&&(typeof self.onloadingprogress)=='function')
self.onloadingprogress(task,prog);};loader.onresource=function(resource){if((resource instanceof JSC3D.Texture)&&self.isMipMappingOn&&!resource.hasMipmap())
resource.generateMipmaps();self.update();};this.abortUnfinishedLoadingFn=function(){loader.abort();self.abortUnfinishedLoadingFn=null;self.hideProgress();if(self.onloadingaborted&&(typeof self.onloadingaborted)=='function')
self.onloadingaborted();};loader.loadFromUrl(this.sceneUrl);if(this.onloadingstarted&&(typeof this.onloadingstarted)=='function')
this.onloadingstarted();return true;};JSC3D.Viewer.prototype.setupScene=function(scene){if(this.creaseAngle>=0){var cAngle=this.creaseAngle;scene.forEachChild(function(mesh){mesh.creaseAngle=cAngle;});}
scene.init();if(!scene.isEmpty()){var d=scene.aabb.lengthOfDiagonal();var w=this.frameWidth;var h=this.frameHeight;this.zoomFactor=(d==0)?1:(w<h?w:h)/d;this.panning=[0,0];}
this.rotMatrix.identity();this.rotMatrix.rotateAboutXAxis(this.initRotX);this.rotMatrix.rotateAboutYAxis(this.initRotY);this.rotMatrix.rotateAboutZAxis(this.initRotZ);this.scene=scene;this.isLoaded=true;this.isFailed=false;this.needUpdate=false;this.needRepaint=false;this.update();this.hideProgress();this.hideError();};JSC3D.Viewer.prototype.reportProgress=function(task,progress){if(!this.progressFrame){var canvasRect=this.canvas.getBoundingClientRect();var r=255-((this.bkgColor1&0xff0000)>>16);var g=255-((this.bkgColor1&0xff00)>>8);var b=255-(this.bkgColor1&0xff);var color='rgb('+r+','+g+','+b+')';var barX=canvasRect.left+40;var barY=canvasRect.top+canvasRect.height*0.38;var barWidth=canvasRect.width-(barX-canvasRect.left)*2;var barHeight=20;this.progressFrame=document.createElement('div');this.progressFrame.style.position='fixed';this.progressFrame.style.left=barX+'px';this.progressFrame.style.top=barY+'px';this.progressFrame.style.width=barWidth-5+'px';this.progressFrame.style.height=barHeight+'px';this.progressFrame.style.border='3px solid '+color;this.progressFrame.style.pointerEvents='none';this.progressFrame.style.zIndex='5000';document.body.appendChild(this.progressFrame);this.progressRectangle=document.createElement('div');this.progressRectangle.style.position='fixed';this.progressRectangle.style.left=(barX+3)+'px';this.progressRectangle.style.top=(barY+3)+'px';this.progressRectangle.style.width='0px';this.progressRectangle.style.height=(barHeight)+'px';this.progressRectangle.style.background=color;this.progressRectangle.style.pointerEvents='none';this.progressRectangle.style.zIndex='10000';document.body.appendChild(this.progressRectangle);if(!this.messagePanel){this.messagePanel=document.createElement('div');this.messagePanel.style.position='fixed';this.messagePanel.style.left=barX+'px';this.messagePanel.style.top=(barY-26)+'px';this.messagePanel.style.width=barWidth-5+'px';this.messagePanel.style.height='14px';this.messagePanel.style.font='bold 18px Courier New';this.messagePanel.style.color=color;this.messagePanel.style.pointerEvents='none';this.messagePanel.style.zIndex='5000';document.body.appendChild(this.messagePanel);}}
if(this.progressFrame.style.display!='block'){this.progressFrame.style.display='block';this.progressRectangle.style.display='block';}
if(task&&this.messagePanel.style.display!='block')
this.messagePanel.style.display='block';this.progressRectangle.style.width=(parseFloat(this.progressFrame.style.width)-4)*progress+'px';this.messagePanel.innerHTML=task;};JSC3D.Viewer.prototype.hideProgress=function(){if(this.progressFrame){this.messagePanel.style.display='none';this.progressFrame.style.display='none';this.progressRectangle.style.display='none';}};JSC3D.Viewer.prototype.reportError=function(message){if(!this.messagePanel){var canvasRect=this.canvas.getBoundingClientRect();var r=255-((this.bkgColor1&0xff0000)>>16);var g=255-((this.bkgColor1&0xff00)>>8);var b=255-(this.bkgColor1&0xff);var color='rgb('+r+','+g+','+b+')';var panelX=canvasRect.left+40;var panelY=canvasRect.top+canvasRect.height*0.38;var panelWidth=canvasRect.width-(panelX-canvasRect.left)*2;var panelHeight=14;this.messagePanel=document.createElement('div');this.messagePanel.style.position='absolute';this.messagePanel.style.left=panelX+'px';this.messagePanel.style.top=(panelY-16)+'px';this.messagePanel.style.width=panelWidth+'px';this.messagePanel.style.height=panelHeight+'px';this.messagePanel.style.font='bold 14px Courier New';this.messagePanel.style.color=color;this.messagePanel.style.pointerEvents='none';document.body.appendChild(this.messagePanel);}
if(this.progressFrame.style.display!='none'){this.progressFrame.style.display='none';this.progressRectangle.style.display='none';}
if(message&&this.messagePanel.style.display!='block')
this.messagePanel.style.display='block';this.messagePanel.innerHTML=message;};JSC3D.Viewer.prototype.hideError=function(){if(this.messagePanel)
this.messagePanel.style.display='none';};JSC3D.Viewer.prototype.generateBackground=function(){if(this.webglBackend){if(this.bkgImage)
this.webglBackend.setBackgroundImage(this.bkgImage);else
this.webglBackend.setBackgroundColors(this.bkgColor1,this.bkgColor2);return;}
if(this.bkgImage)
this.fillBackgroundWithImage();else
this.fillGradientBackground();};JSC3D.Viewer.prototype.fillGradientBackground=function(){var w=this.frameWidth;var h=this.frameHeight;var pixels=this.bkgColorBuffer;var r1=(this.bkgColor1&0xff0000)>>16;var g1=(this.bkgColor1&0xff00)>>8;var b1=this.bkgColor1&0xff;var r2=(this.bkgColor2&0xff0000)>>16;var g2=(this.bkgColor2&0xff00)>>8;var b2=this.bkgColor2&0xff;var pix=0;for(var i=0;i<h;i++){var r=(r1+i*(r2-r1)/h)&0xff;var g=(g1+i*(g2-g1)/h)&0xff;var b=(b1+i*(b2-b1)/h)&0xff;for(var j=0;j<w;j++){pixels[pix++]=r<<16|g<<8|b;}}};JSC3D.Viewer.prototype.fillBackgroundWithImage=function(){var w=this.frameWidth;var h=this.frameHeight;if(this.bkgImage.width<=0||this.bkgImage.height<=0)
return;var isCanvasClean=false;var canvas=JSC3D.Texture.cv;if(!canvas){try{canvas=document.createElement('canvas');JSC3D.Texture.cv=canvas;isCanvasClean=true;}
catch(e){return;}}
if(canvas.width!=w||canvas.height!=h){canvas.width=w;canvas.height=h;isCanvasClean=true;}
var data=null;try{var ctx=canvas.getContext('2d');if(!isCanvasClean)
ctx.clearRect(0,0,w,h);ctx.drawImage(this.bkgImage,0,0,w,h);var imgData=ctx.getImageData(0,0,w,h);data=imgData.data;}
catch(e){return;}
var pixels=this.bkgColorBuffer;var size=w*h;for(var i=0,j=0;i<size;i++,j+=4){pixels[i]=data[j]<<16|data[j+1]<<8|data[j+2];}};JSC3D.Viewer.prototype.drawBackground=function(){if(!this.webglBackend&&!this.ctx2d)
return;this.beginScene();this.endScene();this.paint();};JSC3D.Viewer.prototype.beginScene=function(){if(this.webglBackend){this.webglBackend.beginFrame(this.definition);return;}
var cbuf=this.colorBuffer;var zbuf=this.zBuffer;var sbuf=this.selectionBuffer;var bbuf=this.bkgColorBuffer;var size=this.frameWidth*this.frameHeight;var MIN_Z=-Number.MAX_VALUE;for(var i=0;i<size;i++){cbuf[i]=bbuf[i];zbuf[i]=MIN_Z;sbuf[i]=0;}};JSC3D.Viewer.prototype.endScene=function(){if(this.webglBackend){this.webglBackend.endFrame();return;}
var data=this.canvasData.data;var width=this.canvas.width;var height=this.canvas.height;var cbuf=this.colorBuffer;var cwidth=this.frameWidth;var cheight=this.frameHeight;var csize=cwidth*cheight;switch(this.definition){case'low':var halfWidth=width>>1;var surplus=cwidth-halfWidth;var src=0,dest=0;for(var i=0;i<height;i++){for(var j=0;j<width;j++){var color=cbuf[src];data[dest]=(color&0xff0000)>>16;data[dest+1]=(color&0xff00)>>8;data[dest+2]=color&0xff;data[dest+3]=0xff;src+=(j&1);dest+=4;}
src+=(i&1)?surplus:-halfWidth;}
break;case'high':var src=0,dest=0;for(var i=0;i<height;i++){for(var j=0;j<width;j++){var color0=cbuf[src];var color1=cbuf[src+1];var color2=cbuf[src+cwidth];var color3=cbuf[src+cwidth+1];data[dest]=((color0&0xff0000)+(color1&0xff0000)+(color2&0xff0000)+(color3&0xff0000))>>18;data[dest+1]=((color0&0xff00)+(color1&0xff00)+(color2&0xff00)+(color3&0xff00))>>10;data[dest+2]=((color0&0xff)+(color1&0xff)+(color2&0xff)+(color3&0xff))>>2;data[dest+3]=0xff;src+=2;dest+=4;}
src+=cwidth;}
break;case'standard':default:for(var src=0,dest=0;src<csize;src++,dest+=4){var color=cbuf[src];data[dest]=(color&0xff0000)>>16;data[dest+1]=(color&0xff00)>>8;data[dest+2]=color&0xff;data[dest+3]=0xff;}
break;}};JSC3D.Viewer.prototype.render=function(){if(this.scene.isEmpty())
return;var aabb=this.scene.aabb;if(this.webglBackend){var w=this.frameWidth;var h=this.frameHeight;var d=aabb.lengthOfDiagonal();var ratio=w/h;this.transformMatrix.identity();this.transformMatrix.translate(-(aabb.minX+aabb.maxX)/2,-(aabb.minY+aabb.maxY)/2,-(aabb.minZ+aabb.maxZ)/2);this.transformMatrix.multiply(this.rotMatrix);if(w<h)
this.transformMatrix.scale(2*this.zoomFactor/w,2*this.zoomFactor*ratio/w,-2/d);else
this.transformMatrix.scale(2*this.zoomFactor/(h*ratio),2*this.zoomFactor/h,-2/d);this.transformMatrix.translate(2*this.panning[0]/w,-2*this.panning[1]/h,0);}
else{this.transformMatrix.identity();this.transformMatrix.translate(-(aabb.minX+aabb.maxX)/2,-(aabb.minY+aabb.maxY)/2,-(aabb.minZ+aabb.maxZ)/2);this.transformMatrix.multiply(this.rotMatrix);this.transformMatrix.scale(this.zoomFactor,-this.zoomFactor,this.zoomFactor);this.transformMatrix.translate(this.frameWidth/2+this.panning[0],this.frameHeight/2+this.panning[1],0);}
var renderList=this.sortScene(this.transformMatrix);if(this.webglBackend){this.webglBackend.render(this.scene.getChildren(),this.transformMatrix,this.rotMatrix,this.renderMode,this.defaultMaterial,this.sphereMap);return;}
for(var i=0;i<renderList.length;i++){var mesh=renderList[i];if(!mesh.isTrivial()){JSC3D.Math3D.transformVectors(this.transformMatrix,mesh.vertexBuffer,mesh.transformedVertexBuffer);if(mesh.visible){switch(mesh.renderMode||this.renderMode){case'point':this.renderPoint(mesh);break;case'wireframe':this.renderWireframe(mesh);break;case'flat':this.renderSolidFlat(mesh);break;case'smooth':this.renderSolidSmooth(mesh);break;case'texture':if(mesh.hasTexture())
this.renderSolidTexture(mesh);else
this.renderSolidFlat(mesh);break;case'textureflat':if(mesh.hasTexture())
this.renderTextureFlat(mesh);else
this.renderSolidFlat(mesh);break;case'texturesmooth':if(mesh.isEnvironmentCast&&this.sphereMap!=null&&this.sphereMap.hasData())
this.renderSolidSphereMapped(mesh);else if(mesh.hasTexture())
this.renderTextureSmooth(mesh);else
this.renderSolidSmooth(mesh);break;default:this.renderSolidFlat(mesh);break;}}}}};JSC3D.Viewer.prototype.sortScene=function(mat){var renderList=[];var meshes=this.scene.getChildren();for(var i=0;i<meshes.length;i++){var mesh=meshes[i];if(!mesh.isTrivial()){renderList.push(mesh);var meshCenter=mesh.aabb.center();JSC3D.Math3D.transformVectors(mat,meshCenter,meshCenter);var meshMaterial=mesh.material?mesh.material:this.defaultMaterial;mesh.sortKey={depth:meshCenter[2],isTransparnt:(meshMaterial.transparency>0)||(mesh.hasTexture()?mesh.texture.hasTransparency:false)};}}
renderList.sort(function(mesh0,mesh1){if(!mesh0.sortKey.isTransparnt&&mesh1.sortKey.isTransparnt)
return-1;if(mesh0.sortKey.isTransparnt&&!mesh1.sortKey.isTransparnt)
return 1;if(mesh0.sortKey.isTransparnt)
return mesh0.sortKey.depth-mesh1.sortKey.depth;return mesh1.sortKey.depth-mesh0.sortKey.depth;});return renderList;};JSC3D.Viewer.prototype.renderPoint=function(mesh){var w=this.frameWidth;var h=this.frameHeight;var xbound=w-1;var ybound=h-1;var ibuf=mesh.indexBuffer;var vbuf=mesh.transformedVertexBuffer;var cbuf=this.colorBuffer;var zbuf=this.zBuffer;var sbuf=this.selectionBuffer;var numOfVertices=vbuf.length/3;var id=mesh.internalId;var color=mesh.material?mesh.material.diffuseColor:this.defaultMaterial.diffuseColor;for(var i=0,j=0;i<numOfVertices;i++,j+=3){var x=~~(vbuf[j]+0.5);var y=~~(vbuf[j+1]+0.5);var z=vbuf[j+2];if(x>=0&&x<xbound&&y>=0&&y<ybound){var pix=y*w+x;if(z>zbuf[pix]){zbuf[pix]=z;cbuf[pix]=color;sbuf[pix]=id;}
pix++;if(z>zbuf[pix]){zbuf[pix]=z;cbuf[pix]=color;sbuf[pix]=id;}
pix+=xbound;if(z>zbuf[pix]){zbuf[pix]=z;cbuf[pix]=color;sbuf[pix]=id;}
pix++;if(z>zbuf[pix]){zbuf[pix]=z;cbuf[pix]=color;sbuf[pix]=id;}}}};JSC3D.Viewer.prototype.renderWireframe=function(mesh){var w=this.frameWidth;var h=this.frameHeight;var xbound=w-1;var ybound=h-1;var ibuf=mesh.indexBuffer;var vbuf=mesh.transformedVertexBuffer;var nbuf=mesh.transformedFaceNormalZBuffer;var cbuf=this.colorBuffer;var zbuf=this.zBuffer;var sbuf=this.selectionBuffer;var numOfFaces=mesh.faceCount;var id=mesh.internalId;var color=mesh.material?mesh.material.diffuseColor:this.defaultMaterial.diffuseColor;if(!nbuf||nbuf.length<numOfFaces){mesh.transformedFaceNormalZBuffer=new Array(numOfFaces);nbuf=mesh.transformedFaceNormalZBuffer;}
JSC3D.Math3D.transformVectorZs(this.rotMatrix,mesh.faceNormalBuffer,nbuf);var i=0,j=0;while(i<numOfFaces){var xformedNz=nbuf[i++];if(mesh.isDoubleSided)
xformedNz=xformedNz>0?xformedNz:-xformedNz;if(xformedNz<0){do{}while(ibuf[j++]!=-1);}
else{var vStart,v0,v1;v0=ibuf[j++]*3;v1=ibuf[j++]*3;vStart=v0;var isClosed=false;while(!isClosed){var x0=~~(vbuf[v0]+0.5);var y0=~~(vbuf[v0+1]+0.5);var z0=vbuf[v0+2];var x1=~~(vbuf[v1]+0.5);var y1=~~(vbuf[v1+1]+0.5);var z1=vbuf[v1+2];var dx=x1-x0;var dy=y1-y0;var dz=z1-z0;var dd;var xInc,yInc,zInc;if(Math.abs(dx)>Math.abs(dy)){dd=dx;xInc=dx>0?1:-1;yInc=dx!=0?xInc*dy/dx:0;zInc=dx!=0?xInc*dz/dx:0;}
else{dd=dy;yInc=dy>0?1:-1;xInc=dy!=0?yInc*dx/dy:0;zInc=dy!=0?yInc*dz/dy:0;}
var x=x0;var y=y0;var z=z0;if(dd<0){x=x1;y=y1;z=z1;dd=-dd;xInc=-xInc;yInc=-yInc;zInc=-zInc;}
for(var k=0;k<dd;k++){if(x>=0&&x<xbound&&y>=0&&y<ybound){var pix=(~~y)*w+(~~x);if(z>zbuf[pix]){zbuf[pix]=z;cbuf[pix]=color;sbuf[pix]=id;}}
x+=xInc;y+=yInc;z+=zInc;}
if(v1==vStart){isClosed=true;}
else{v0=v1;if(ibuf[j]!=-1){v1=ibuf[j++]*3;}
else{v1=vStart;}}}
j++;}}};JSC3D.Viewer.prototype.renderSolidFlat=function(mesh){var w=this.frameWidth;var h=this.frameHeight;var ibuf=mesh.indexBuffer;var vbuf=mesh.transformedVertexBuffer;var nbuf=mesh.transformedFaceNormalZBuffer;var cbuf=this.colorBuffer;var zbuf=this.zBuffer;var sbuf=this.selectionBuffer;var numOfFaces=mesh.faceCount;var id=mesh.internalId;var material=mesh.material?mesh.material:this.defaultMaterial;var palette=material.getPalette();var isOpaque=material.transparency==0;var trans=material.transparency*255;var opaci=255-trans;var fixForMacSafari=1*null;if(material.transparency==1)
return;if(!nbuf||nbuf.length<numOfFaces){mesh.transformedFaceNormalZBuffer=new Array(numOfFaces);nbuf=mesh.transformedFaceNormalZBuffer;}
JSC3D.Math3D.transformVectorZs(this.rotMatrix,mesh.faceNormalBuffer,nbuf);var Xs=new Array(3);var Ys=new Array(3);var Zs=new Array(3);var i=0,j=0;while(i<numOfFaces){var xformedNz=nbuf[i++];if(mesh.isDoubleSided)
xformedNz=xformedNz>0?xformedNz:-xformedNz;if(xformedNz<0){do{}while(ibuf[j++]!=-1);}
else{var color=palette[~~(xformedNz*255)];var v0,v1,v2;v0=ibuf[j++]*3;v1=ibuf[j++]*3;do{v2=ibuf[j++]*3;Xs[0]=~~(vbuf[v0]+0.5);Ys[0]=~~(vbuf[v0+1]+0.5);Zs[0]=vbuf[v0+2];Xs[1]=~~(vbuf[v1]+0.5);Ys[1]=~~(vbuf[v1+1]+0.5);Zs[1]=vbuf[v1+2];Xs[2]=~~(vbuf[v2]+0.5);Ys[2]=~~(vbuf[v2+1]+0.5);Zs[2]=vbuf[v2+2];var high=Ys[0]<Ys[1]?0:1;high=Ys[high]<Ys[2]?high:2;var low=Ys[0]>Ys[1]?0:1;low=Ys[low]>Ys[2]?low:2;var mid=3-low-high;if(high!=low){var x0=Xs[low];var z0=Zs[low];var dy0=Ys[low]-Ys[high];dy0=dy0!=0?dy0:1;var xStep0=(Xs[low]-Xs[high])/dy0;var zStep0=(Zs[low]-Zs[high])/dy0;var x1=Xs[low];var z1=Zs[low];var dy1=Ys[low]-Ys[mid];dy1=dy1!=0?dy1:1;var xStep1=(Xs[low]-Xs[mid])/dy1;var zStep1=(Zs[low]-Zs[mid])/dy1;var x2=Xs[mid];var z2=Zs[mid];var dy2=Ys[mid]-Ys[high];dy2=dy2!=0?dy2:1;var xStep2=(Xs[mid]-Xs[high])/dy2;var zStep2=(Zs[mid]-Zs[high])/dy2;var linebase=Ys[low]*w;for(var y=Ys[low];y>Ys[high];y--){if(y>=0&&y<h){var xLeft=~~x0;var zLeft=z0;var xRight,zRight;if(y>Ys[mid]){xRight=~~x1;zRight=z1;}
else{xRight=~~x2;zRight=z2;}
if(xLeft>xRight){var temp;temp=xLeft;xLeft=xRight;xRight=temp;temp=zLeft;zLeft=zRight;zRight=temp;}
if(xLeft<0)
xLeft=0;if(xRight>=w)
xRight=w-1;var zInc=(xLeft!=xRight)?((zRight-zLeft)/(xRight-xLeft)):1;var pix=linebase+xLeft;if(isOpaque){for(var x=xLeft,z=zLeft;x<=xRight;x++,z+=zInc){if(z>zbuf[pix]){zbuf[pix]=z;cbuf[pix]=color;sbuf[pix]=id;}
pix++;}}
else{for(var x=xLeft,z=zLeft;x<xRight;x++,z+=zInc){if(z>zbuf[pix]){var foreColor=color;var backColor=cbuf[pix];var rr=((backColor&0xff0000)*trans+(foreColor&0xff0000)*opaci)>>8;var gg=((backColor&0xff00)*trans+(foreColor&0xff00)*opaci)>>8;var bb=((backColor&0xff)*trans+(foreColor&0xff)*opaci)>>8;cbuf[pix]=(rr&0xff0000)|(gg&0xff00)|(bb&0xff);sbuf[pix]=id;}
pix++;}}}
x0-=xStep0;z0-=zStep0;if(y>Ys[mid]){x1-=xStep1;z1-=zStep1;}
else{x2-=xStep2;z2-=zStep2;}
linebase-=w;}}
v1=v2;}while(ibuf[j]!=-1);j++;}}};JSC3D.Viewer.prototype.renderSolidSmooth=function(mesh){var w=this.frameWidth;var h=this.frameHeight;var ibuf=mesh.indexBuffer;var vbuf=mesh.transformedVertexBuffer;var vnbuf=mesh.transformedVertexNormalZBuffer;var vnibuf=mesh.vertexNormalIndexBuffer?mesh.vertexNormalIndexBuffer:mesh.indexBuffer;var fnbuf=mesh.transformedFaceNormalZBuffer;var cbuf=this.colorBuffer;var zbuf=this.zBuffer;var sbuf=this.selectionBuffer;var numOfFaces=mesh.faceCount;var numOfVertices=vbuf.length/3;var id=mesh.internalId;var material=mesh.material?mesh.material:this.defaultMaterial;var palette=material.getPalette();var isOpaque=material.transparency==0;var trans=material.transparency*255;var opaci=255-trans;var fixForMacSafari=1*null;if(material.transparency==1)
return;if(!vnbuf||vnbuf.length<mesh.vertexNormalBuffer.length/3){mesh.transformedVertexNormalZBuffer=new Array(mesh.vertexNormalBuffer.length/3);vnbuf=mesh.transformedVertexNormalZBuffer;}
if(!fnbuf||fnbuf.length<numOfFaces){mesh.transformedFaceNormalZBuffer=new Array(numOfFaces);fnbuf=mesh.transformedFaceNormalZBuffer;}
JSC3D.Math3D.transformVectorZs(this.rotMatrix,mesh.vertexNormalBuffer,vnbuf);JSC3D.Math3D.transformVectorZs(this.rotMatrix,mesh.faceNormalBuffer,fnbuf);var isDoubleSided=mesh.isDoubleSided;var Xs=new Array(3);var Ys=new Array(3);var Zs=new Array(3);var Ns=new Array(3);var i=0,j=0;while(i<numOfFaces){var xformedFNz=fnbuf[i++];if(isDoubleSided)
xformedFNz=xformedFNz>0?xformedFNz:-xformedFNz;if(xformedFNz<0){do{}while(ibuf[j++]!=-1);}
else{var i0,i1,i2;var v0,v1,v2;var ni0,ni1,ni2;i0=ibuf[j];v0=i0*3;ni0=vnibuf[j];j++;i1=ibuf[j];v1=i1*3;ni1=vnibuf[j];j++;do{i2=ibuf[j];v2=i2*3;ni2=vnibuf[j];j++;Xs[0]=~~(vbuf[v0]+0.5);Ys[0]=~~(vbuf[v0+1]+0.5);Zs[0]=vbuf[v0+2];Xs[1]=~~(vbuf[v1]+0.5);Ys[1]=~~(vbuf[v1+1]+0.5);Zs[1]=vbuf[v1+2];Xs[2]=~~(vbuf[v2]+0.5);Ys[2]=~~(vbuf[v2+1]+0.5);Zs[2]=vbuf[v2+2];Ns[0]=vnbuf[ni0];Ns[1]=vnbuf[ni1];Ns[2]=vnbuf[ni2];if(isDoubleSided){if(Ns[0]<0)
Ns[0]=-Ns[0];if(Ns[1]<0)
Ns[1]=-Ns[1];if(Ns[2]<0)
Ns[2]=-Ns[2];}
var high=Ys[0]<Ys[1]?0:1;high=Ys[high]<Ys[2]?high:2;var low=Ys[0]>Ys[1]?0:1;low=Ys[low]>Ys[2]?low:2;var mid=3-low-high;if(high!=low){var x0=Xs[low];var z0=Zs[low];var n0=Ns[low]*255;var dy0=Ys[low]-Ys[high];dy0=dy0!=0?dy0:1;var xStep0=(Xs[low]-Xs[high])/dy0;var zStep0=(Zs[low]-Zs[high])/dy0;var nStep0=(Ns[low]-Ns[high])*255/dy0;var x1=Xs[low];var z1=Zs[low];var n1=Ns[low]*255;var dy1=Ys[low]-Ys[mid];dy1=dy1!=0?dy1:1;var xStep1=(Xs[low]-Xs[mid])/dy1;var zStep1=(Zs[low]-Zs[mid])/dy1;var nStep1=(Ns[low]-Ns[mid])*255/dy1;var x2=Xs[mid];var z2=Zs[mid];var n2=Ns[mid]*255;var dy2=Ys[mid]-Ys[high];dy2=dy2!=0?dy2:1;var xStep2=(Xs[mid]-Xs[high])/dy2;var zStep2=(Zs[mid]-Zs[high])/dy2;var nStep2=(Ns[mid]-Ns[high])*255/dy2;var linebase=Ys[low]*w;for(var y=Ys[low];y>Ys[high];y--){if(y>=0&&y<h){var xLeft=~~x0;var zLeft=z0;var nLeft=n0;var xRight,zRight,nRight;if(y>Ys[mid]){xRight=~~x1;zRight=z1;nRight=n1;}
else{xRight=~~x2;zRight=z2;nRight=n2;}
if(xLeft>xRight){var temp;temp=xLeft;xLeft=xRight;xRight=temp;temp=zLeft;zLeft=zRight;zRight=temp;temp=nLeft;nLeft=nRight;nRight=temp;}
var zInc=(xLeft!=xRight)?((zRight-zLeft)/(xRight-xLeft)):1;var nInc=(xLeft!=xRight)?((nRight-nLeft)/(xRight-xLeft)):1;if(xLeft<0){zLeft-=xLeft*zInc;nLeft-=xLeft*nInc;xLeft=0;}
if(xRight>=w){xRight=w-1;}
var pix=linebase+xLeft;if(isOpaque){for(var x=xLeft,z=zLeft,n=nLeft;x<=xRight;x++,z+=zInc,n+=nInc){if(z>zbuf[pix]){zbuf[pix]=z;cbuf[pix]=palette[n>0?(~~n):0];sbuf[pix]=id;}
pix++;}}
else{for(var x=xLeft,z=zLeft,n=nLeft;x<xRight;x++,z+=zInc,n+=nInc){if(z>zbuf[pix]){var foreColor=palette[n>0?(~~n):0];var backColor=cbuf[pix];var rr=((backColor&0xff0000)*trans+(foreColor&0xff0000)*opaci)>>8;var gg=((backColor&0xff00)*trans+(foreColor&0xff00)*opaci)>>8;var bb=((backColor&0xff)*trans+(foreColor&0xff)*opaci)>>8;cbuf[pix]=(rr&0xff0000)|(gg&0xff00)|(bb&0xff);sbuf[pix]=id;}
pix++;}}}
x0-=xStep0;z0-=zStep0;n0-=nStep0;if(y>Ys[mid]){x1-=xStep1;z1-=zStep1;n1-=nStep1;}
else{x2-=xStep2;z2-=zStep2;n2-=nStep2;}
linebase-=w;}}
v1=v2;i1=i2;ni1=ni2;}while(ibuf[j]!=-1);j++;}}};JSC3D.Viewer.prototype.renderSolidTexture=function(mesh){var w=this.frameWidth;var h=this.frameHeight;var ibuf=mesh.indexBuffer;var vbuf=mesh.transformedVertexBuffer;var nbuf=mesh.transformedFaceNormalZBuffer;var cbuf=this.colorBuffer;var zbuf=this.zBuffer;var sbuf=this.selectionBuffer;var numOfFaces=mesh.faceCount;var id=mesh.internalId;var texture=mesh.texture;var isOpaque=!texture.hasTransparency;var tbuf=mesh.texCoordBuffer;var tibuf=mesh.texCoordIndexBuffer?mesh.texCoordIndexBuffer:mesh.indexBuffer;var tdata=texture.data;var tdim=texture.width;var tbound=tdim-1;var mipmaps=texture.hasMipmap()?texture.mipmaps:null;var mipentries=mipmaps?texture.mipentries:null;var fixForMacSafari=1*null;if(!nbuf||nbuf.length<numOfFaces){mesh.transformedFaceNormalZBuffer=new Array(numOfFaces);nbuf=mesh.transformedFaceNormalZBuffer;}
JSC3D.Math3D.transformVectorZs(this.rotMatrix,mesh.faceNormalBuffer,nbuf);var Xs=new Array(3);var Ys=new Array(3);var Zs=new Array(3);var THs=new Array(3);var TVs=new Array(3);var i=0,j=0;while(i<numOfFaces){var xformedNz=nbuf[i++];if(mesh.isDoubleSided)
xformedNz=xformedNz>0?xformedNz:-xformedNz;if(xformedNz<0){do{}while(ibuf[j++]!=-1);}
else{var v0,v1,v2;var t0,t1,t2;v0=ibuf[j]*3;t0=tibuf[j]*2;j++;v1=ibuf[j]*3;t1=tibuf[j]*2;j++;if(mipmaps){v2=ibuf[j]*3;t2=tibuf[j]*2;tdim=texture.width;Xs[0]=vbuf[v0];Ys[0]=vbuf[v0+1];Xs[1]=vbuf[v1];Ys[1]=vbuf[v1+1];Xs[2]=vbuf[v2];Ys[2]=vbuf[v2+1];THs[0]=tbuf[t0]*tdim;TVs[0]=tbuf[t0+1]*tdim;THs[1]=tbuf[t1]*tdim;TVs[1]=tbuf[t1+1]*tdim;THs[2]=tbuf[t2]*tdim;TVs[2]=tbuf[t2+1]*tdim;var faceArea=(Xs[1]-Xs[0])*(Ys[2]-Ys[0])-(Ys[1]-Ys[0])*(Xs[2]-Xs[0]);if(faceArea<0)
faceArea=-faceArea;faceArea+=1;var texArea=(THs[1]-THs[0])*(TVs[2]-TVs[0])-(TVs[1]-TVs[0])*(THs[2]-THs[0]);if(texArea<0)
texArea=-texArea;var mipRatio=texArea/faceArea;var level=0;if(mipRatio<mipentries[1])
level=0;else if(mipRatio>=mipentries[mipentries.length-1]){level=mipentries.length-1;tdim=1;}
else{while(mipRatio>=mipentries[level+1]){level++;tdim/=2;}}
tdata=mipmaps[level];tbound=tdim-1;}
do{v2=ibuf[j]*3;t2=tibuf[j]*2;j++;Xs[0]=~~(vbuf[v0]+0.5);Ys[0]=~~(vbuf[v0+1]+0.5);Zs[0]=vbuf[v0+2];Xs[1]=~~(vbuf[v1]+0.5);Ys[1]=~~(vbuf[v1+1]+0.5);Zs[1]=vbuf[v1+2];Xs[2]=~~(vbuf[v2]+0.5);Ys[2]=~~(vbuf[v2+1]+0.5);Zs[2]=vbuf[v2+2];THs[0]=tbuf[t0]*tdim;TVs[0]=tbuf[t0+1]*tdim;THs[1]=tbuf[t1]*tdim;TVs[1]=tbuf[t1+1]*tdim;THs[2]=tbuf[t2]*tdim;TVs[2]=tbuf[t2+1]*tdim;var high=Ys[0]<Ys[1]?0:1;high=Ys[high]<Ys[2]?high:2;var low=Ys[0]>Ys[1]?0:1;low=Ys[low]>Ys[2]?low:2;var mid=3-low-high;if(high!=low){var x0=Xs[low];var z0=Zs[low];var th0=THs[low];var tv0=TVs[low];var dy0=Ys[low]-Ys[high];dy0=dy0!=0?dy0:1;var xStep0=(Xs[low]-Xs[high])/dy0;var zStep0=(Zs[low]-Zs[high])/dy0;var thStep0=(THs[low]-THs[high])/dy0;var tvStep0=(TVs[low]-TVs[high])/dy0;var x1=Xs[low];var z1=Zs[low];var th1=THs[low];var tv1=TVs[low];var dy1=Ys[low]-Ys[mid];dy1=dy1!=0?dy1:1;var xStep1=(Xs[low]-Xs[mid])/dy1;var zStep1=(Zs[low]-Zs[mid])/dy1;var thStep1=(THs[low]-THs[mid])/dy1;var tvStep1=(TVs[low]-TVs[mid])/dy1;var x2=Xs[mid];var z2=Zs[mid];var th2=THs[mid];var tv2=TVs[mid];var dy2=Ys[mid]-Ys[high];dy2=dy2!=0?dy2:1;var xStep2=(Xs[mid]-Xs[high])/dy2;var zStep2=(Zs[mid]-Zs[high])/dy2;var thStep2=(THs[mid]-THs[high])/dy2;var tvStep2=(TVs[mid]-TVs[high])/dy2;var linebase=Ys[low]*w;for(var y=Ys[low];y>Ys[high];y--){if(y>=0&&y<h){var xLeft=~~x0;var zLeft=z0;var thLeft=th0;var tvLeft=tv0;var xRight,zRight,thRight,tvRight;if(y>Ys[mid]){xRight=~~x1;zRight=z1;thRight=th1;tvRight=tv1;}
else{xRight=~~x2;zRight=z2;thRight=th2;tvRight=tv2;}
if(xLeft>xRight){var temp;temp=xLeft;xLeft=xRight;xRight=temp;temp=zLeft;zLeft=zRight;zRight=temp;temp=thLeft;thLeft=thRight;thRight=temp;temp=tvLeft;tvLeft=tvRight;tvRight=temp;}
var zInc=(xLeft!=xRight)?((zRight-zLeft)/(xRight-xLeft)):1;var thInc=(xLeft!=xRight)?((thRight-thLeft)/(xRight-xLeft)):1;var tvInc=(xLeft!=xRight)?((tvRight-tvLeft)/(xRight-xLeft)):1;if(xLeft<0){zLeft-=xLeft*zInc;thLeft-=xLeft*thInc;tvLeft-=xLeft*tvInc;xLeft=0;}
if(xRight>=w)
xRight=w-1;var pix=linebase+xLeft;if(isOpaque){for(var x=xLeft,z=zLeft,th=thLeft,tv=tvLeft;x<=xRight;x++,z+=zInc,th+=thInc,tv+=tvInc){if(z>zbuf[pix]){zbuf[pix]=z;cbuf[pix]=tdata[(tv&tbound)*tdim+(th&tbound)];sbuf[pix]=id;}
pix++;}}
else{for(var x=xLeft,z=zLeft,th=thLeft,tv=tvLeft;x<xRight;x++,z+=zInc,th+=thInc,tv+=tvInc){if(z>zbuf[pix]){var foreColor=tdata[(tv&tbound)*tdim+(th&tbound)];var backColor=cbuf[pix];var opaci=(foreColor>>24)&0xff;var trans=255-opaci;var rr=((backColor&0xff0000)*trans+(foreColor&0xff0000)*opaci)>>8;var gg=((backColor&0xff00)*trans+(foreColor&0xff00)*opaci)>>8;var bb=((backColor&0xff)*trans+(foreColor&0xff)*opaci)>>8;cbuf[pix]=(rr&0xff0000)|(gg&0xff00)|(bb&0xff);sbuf[pix]=id;}
pix++;}}}
x0-=xStep0;z0-=zStep0;th0-=thStep0;tv0-=tvStep0;if(y>Ys[mid]){x1-=xStep1;z1-=zStep1;th1-=thStep1;tv1-=tvStep1;}
else{x2-=xStep2;z2-=zStep2;th2-=thStep2;tv2-=tvStep2;}
linebase-=w;}}
v1=v2;t1=t2;}while(ibuf[j]!=-1);j++;}}};JSC3D.Viewer.prototype.renderTextureFlat=function(mesh){var w=this.frameWidth;var h=this.frameHeight;var ibuf=mesh.indexBuffer;var vbuf=mesh.transformedVertexBuffer;var nbuf=mesh.transformedFaceNormalZBuffer;var cbuf=this.colorBuffer;var zbuf=this.zBuffer;var sbuf=this.selectionBuffer;var numOfFaces=mesh.faceCount;var id=mesh.internalId;var material=mesh.material?mesh.material:this.defaultMaterial;var palette=material.getPalette();var texture=mesh.texture;var isOpaque=(material.transparency==0)&&!texture.hasTransparency;var matOpacity=~~((1-material.transparency)*255);var tbuf=mesh.texCoordBuffer;var tibuf=mesh.texCoordIndexBuffer?mesh.texCoordIndexBuffer:mesh.indexBuffer;var tdata=texture.data;var tdim=texture.width;var tbound=tdim-1;var mipmaps=texture.hasMipmap()?texture.mipmaps:null;var mipentries=mipmaps?texture.mipentries:null;var fixForMacSafari=1*null;if(material.transparency==1)
return;if(!nbuf||nbuf.length<numOfFaces){mesh.transformedFaceNormalZBuffer=new Array(numOfFaces);nbuf=mesh.transformedFaceNormalZBuffer;}
JSC3D.Math3D.transformVectorZs(this.rotMatrix,mesh.faceNormalBuffer,nbuf);var Xs=new Array(3);var Ys=new Array(3);var Zs=new Array(3);var THs=new Array(3);var TVs=new Array(3);var i=0,j=0;while(i<numOfFaces){var xformedNz=nbuf[i++];if(mesh.isDoubleSided)
xformedNz=xformedNz>0?xformedNz:-xformedNz;if(xformedNz<0){do{}while(ibuf[j++]!=-1);}
else{var color=palette[~~(xformedNz*255)];var v0,v1,v2;var t0,t1,t2;v0=ibuf[j]*3;t0=tibuf[j]*2;j++;v1=ibuf[j]*3;t1=tibuf[j]*2;j++;if(mipmaps){v2=ibuf[j]*3;t2=tibuf[j]*2;tdim=texture.width;Xs[0]=vbuf[v0];Ys[0]=vbuf[v0+1];Xs[1]=vbuf[v1];Ys[1]=vbuf[v1+1];Xs[2]=vbuf[v2];Ys[2]=vbuf[v2+1];THs[0]=tbuf[t0]*tdim;TVs[0]=tbuf[t0+1]*tdim;THs[1]=tbuf[t1]*tdim;TVs[1]=tbuf[t1+1]*tdim;THs[2]=tbuf[t2]*tdim;TVs[2]=tbuf[t2+1]*tdim;var faceArea=(Xs[1]-Xs[0])*(Ys[2]-Ys[0])-(Ys[1]-Ys[0])*(Xs[2]-Xs[0]);if(faceArea<0)
faceArea=-faceArea;faceArea+=1;var texArea=(THs[1]-THs[0])*(TVs[2]-TVs[0])-(TVs[1]-TVs[0])*(THs[2]-THs[0]);if(texArea<0)
texArea=-texArea;var mipRatio=texArea/faceArea;var level=0;if(mipRatio<mipentries[1])
level=0;else if(mipRatio>=mipentries[mipentries.length-1]){level=mipentries.length-1;tdim=1;}
else{while(mipRatio>=mipentries[level+1]){level++;tdim/=2;}}
tdata=mipmaps[level];tbound=tdim-1;}
do{v2=ibuf[j]*3;t2=tibuf[j]*2;j++;Xs[0]=~~(vbuf[v0]+0.5);Ys[0]=~~(vbuf[v0+1]+0.5);Zs[0]=vbuf[v0+2];Xs[1]=~~(vbuf[v1]+0.5);Ys[1]=~~(vbuf[v1+1]+0.5);Zs[1]=vbuf[v1+2];Xs[2]=~~(vbuf[v2]+0.5);Ys[2]=~~(vbuf[v2+1]+0.5);Zs[2]=vbuf[v2+2];THs[0]=tbuf[t0]*tdim;TVs[0]=tbuf[t0+1]*tdim;THs[1]=tbuf[t1]*tdim;TVs[1]=tbuf[t1+1]*tdim;THs[2]=tbuf[t2]*tdim;TVs[2]=tbuf[t2+1]*tdim;var high=Ys[0]<Ys[1]?0:1;high=Ys[high]<Ys[2]?high:2;var low=Ys[0]>Ys[1]?0:1;low=Ys[low]>Ys[2]?low:2;var mid=3-low-high;if(high!=low){var x0=Xs[low];var z0=Zs[low];var th0=THs[low];var tv0=TVs[low];var dy0=Ys[low]-Ys[high];dy0=dy0!=0?dy0:1;var xStep0=(Xs[low]-Xs[high])/dy0;var zStep0=(Zs[low]-Zs[high])/dy0;var thStep0=(THs[low]-THs[high])/dy0;var tvStep0=(TVs[low]-TVs[high])/dy0;var x1=Xs[low];var z1=Zs[low];var th1=THs[low];var tv1=TVs[low];var dy1=Ys[low]-Ys[mid];dy1=dy1!=0?dy1:1;var xStep1=(Xs[low]-Xs[mid])/dy1;var zStep1=(Zs[low]-Zs[mid])/dy1;var thStep1=(THs[low]-THs[mid])/dy1;var tvStep1=(TVs[low]-TVs[mid])/dy1;var x2=Xs[mid];var z2=Zs[mid];var th2=THs[mid];var tv2=TVs[mid];var dy2=Ys[mid]-Ys[high];dy2=dy2!=0?dy2:1;var xStep2=(Xs[mid]-Xs[high])/dy2;var zStep2=(Zs[mid]-Zs[high])/dy2;var thStep2=(THs[mid]-THs[high])/dy2;var tvStep2=(TVs[mid]-TVs[high])/dy2;var linebase=Ys[low]*w;for(var y=Ys[low];y>Ys[high];y--){if(y>=0&&y<h){var xLeft=~~x0;var zLeft=z0;var thLeft=th0;var tvLeft=tv0;var xRight,zRight,thRight,tvRight;if(y>Ys[mid]){xRight=~~x1;zRight=z1;thRight=th1;tvRight=tv1;}
else{xRight=~~x2;zRight=z2;thRight=th2;tvRight=tv2;}
if(xLeft>xRight){var temp;temp=xLeft;xLeft=xRight;xRight=temp;temp=zLeft;zLeft=zRight;zRight=temp;temp=thLeft;thLeft=thRight;thRight=temp;temp=tvLeft;tvLeft=tvRight;tvRight=temp;}
var zInc=(xLeft!=xRight)?((zRight-zLeft)/(xRight-xLeft)):1;var thInc=(xLeft!=xRight)?((thRight-thLeft)/(xRight-xLeft)):1;var tvInc=(xLeft!=xRight)?((tvRight-tvLeft)/(xRight-xLeft)):1;if(xLeft<0){zLeft-=xLeft*zInc;thLeft-=xLeft*thInc;tvLeft-=xLeft*tvInc;xLeft=0;}
if(xRight>=w)
xRight=w-1;var pix=linebase+xLeft;if(isOpaque){for(var x=xLeft,z=zLeft,th=thLeft,tv=tvLeft;x<=xRight;x++,z+=zInc,th+=thInc,tv+=tvInc){if(z>zbuf[pix]){zbuf[pix]=z;var texel=tdata[(tv&tbound)*tdim+(th&tbound)];var rr=(((color&0xff0000)>>16)*((texel&0xff0000)>>8));var gg=(((color&0xff00)>>8)*((texel&0xff00)>>8));var bb=((color&0xff)*(texel&0xff))>>8;cbuf[pix]=(rr&0xff0000)|(gg&0xff00)|(bb&0xff);sbuf[pix]=id;}
pix++;}}
else{for(var x=xLeft,z=zLeft,th=thLeft,tv=tvLeft;x<xRight;x++,z+=zInc,th+=thInc,tv+=tvInc){if(z>zbuf[pix]){var foreColor=tdata[(tv&tbound)*tdim+(th&tbound)];var backColor=cbuf[pix];var opaci=(((foreColor>>24)&0xff)*(matOpacity&0xff))>>8;var rr=(((color&0xff0000)>>16)*((foreColor&0xff0000)>>8));var gg=(((color&0xff00)>>8)*((foreColor&0xff00)>>8));var bb=((color&0xff)*(foreColor&0xff))>>8;if(opaci>250){zbuf[pix]=z;}
else{var trans=255-opaci;rr=(rr*opaci+(backColor&0xff0000)*trans)>>8;gg=(gg*opaci+(backColor&0xff00)*trans)>>8;bb=(bb*opaci+(backColor&0xff)*trans)>>8;}
cbuf[pix]=(rr&0xff0000)|(gg&0xff00)|(bb&0xff);sbuf[pix]=id;}
pix++;}}}
x0-=xStep0;z0-=zStep0;th0-=thStep0;tv0-=tvStep0;if(y>Ys[mid]){x1-=xStep1;z1-=zStep1;th1-=thStep1;tv1-=tvStep1;}
else{x2-=xStep2;z2-=zStep2;th2-=thStep2;tv2-=tvStep2;}
linebase-=w;}}
v1=v2;t1=t2;}while(ibuf[j]!=-1);j++;}}};JSC3D.Viewer.prototype.renderTextureSmooth=function(mesh){var w=this.frameWidth;var h=this.frameHeight;var ibuf=mesh.indexBuffer;var vbuf=mesh.transformedVertexBuffer;var vnbuf=mesh.transformedVertexNormalZBuffer;var vnibuf=mesh.vertexNormalIndexBuffer?mesh.vertexNormalIndexBuffer:mesh.indexBuffer;var fnbuf=mesh.transformedFaceNormalZBuffer;var cbuf=this.colorBuffer;var zbuf=this.zBuffer;var sbuf=this.selectionBuffer;var numOfFaces=mesh.faceCount;var id=mesh.internalId;var numOfVertices=vbuf.length/3;var material=mesh.material?mesh.material:this.defaultMaterial;var palette=material.getPalette();var texture=mesh.texture;var isOpaque=(material.transparency==0)&&!texture.hasTransparency;var matOpacity=~~((1-material.transparency)*255);var tbuf=mesh.texCoordBuffer;var tibuf=mesh.texCoordIndexBuffer?mesh.texCoordIndexBuffer:mesh.indexBuffer;var tdata=texture.data;var tdim=texture.width;var tbound=tdim-1;var mipmaps=texture.hasMipmap()?texture.mipmaps:null;var mipentries=mipmaps?texture.mipentries:null;var fixForMacSafari=1*null;if(material.transparency==1)
return;if(!vnbuf||vnbuf.length<mesh.vertexNormalBuffer.length/3){mesh.transformedVertexNormalZBuffer=new Array(mesh.vertexNormalBuffer.length/3);vnbuf=mesh.transformedVertexNormalZBuffer;}
if(!fnbuf||fnbuf.length<numOfFaces){mesh.transformedFaceNormalZBuffer=new Array(numOfFaces);fnbuf=mesh.transformedFaceNormalZBuffer;}
JSC3D.Math3D.transformVectorZs(this.rotMatrix,mesh.vertexNormalBuffer,vnbuf);JSC3D.Math3D.transformVectorZs(this.rotMatrix,mesh.faceNormalBuffer,fnbuf);var isDoubleSided=mesh.isDoubleSided;var Xs=new Array(3);var Ys=new Array(3);var Zs=new Array(3);var Ns=new Array(3);var THs=new Array(3);var TVs=new Array(3);var i=0,j=0;while(i<numOfFaces){var xformedFNz=fnbuf[i++];if(isDoubleSided)
xformedFNz=xformedFNz>0?xformedFNz:-xformedFNz;if(xformedFNz<0){do{}while(ibuf[j++]!=-1);}
else{var i0,i1,i2;var v0,v1,v2;var t0,t1,t2;var ni0,ni1,ni2;i0=ibuf[j];v0=i0*3;t0=tibuf[j]*2;ni0=vnibuf[j];j++;i1=ibuf[j];v1=i1*3;t1=tibuf[j]*2;ni1=vnibuf[j];j++;if(mipmaps){v2=ibuf[j]*3;t2=tibuf[j]*2;tdim=texture.width;Xs[0]=vbuf[v0];Ys[0]=vbuf[v0+1];Xs[1]=vbuf[v1];Ys[1]=vbuf[v1+1];Xs[2]=vbuf[v2];Ys[2]=vbuf[v2+1];THs[0]=tbuf[t0]*tdim;TVs[0]=tbuf[t0+1]*tdim;THs[1]=tbuf[t1]*tdim;TVs[1]=tbuf[t1+1]*tdim;THs[2]=tbuf[t2]*tdim;TVs[2]=tbuf[t2+1]*tdim;var faceArea=(Xs[1]-Xs[0])*(Ys[2]-Ys[0])-(Ys[1]-Ys[0])*(Xs[2]-Xs[0]);if(faceArea<0)
faceArea=-faceArea;faceArea+=1;var texArea=(THs[1]-THs[0])*(TVs[2]-TVs[0])-(TVs[1]-TVs[0])*(THs[2]-THs[0]);if(texArea<0)
texArea=-texArea;var mipRatio=texArea/faceArea;var level=0;if(mipRatio<mipentries[1])
level=0;else if(mipRatio>=mipentries[mipentries.length-1]){level=mipentries.length-1;tdim=1;}
else{while(mipRatio>=mipentries[level+1]){level++;tdim/=2;}}
tdata=mipmaps[level];tbound=tdim-1;}
do{i2=ibuf[j];v2=i2*3;t2=tibuf[j]*2;ni2=vnibuf[j];j++;Xs[0]=~~(vbuf[v0]+0.5);Ys[0]=~~(vbuf[v0+1]+0.5);Zs[0]=vbuf[v0+2];Xs[1]=~~(vbuf[v1]+0.5);Ys[1]=~~(vbuf[v1+1]+0.5);Zs[1]=vbuf[v1+2];Xs[2]=~~(vbuf[v2]+0.5);Ys[2]=~~(vbuf[v2+1]+0.5);Zs[2]=vbuf[v2+2];THs[0]=tbuf[t0]*tdim;TVs[0]=tbuf[t0+1]*tdim;THs[1]=tbuf[t1]*tdim;TVs[1]=tbuf[t1+1]*tdim;THs[2]=tbuf[t2]*tdim;TVs[2]=tbuf[t2+1]*tdim;Ns[0]=vnbuf[ni0];Ns[1]=vnbuf[ni1];Ns[2]=vnbuf[ni2];if(isDoubleSided){if(Ns[0]<0)
Ns[0]=-Ns[0];if(Ns[1]<0)
Ns[1]=-Ns[1];if(Ns[2]<0)
Ns[2]=-Ns[2];}
var high=Ys[0]<Ys[1]?0:1;high=Ys[high]<Ys[2]?high:2;var low=Ys[0]>Ys[1]?0:1;low=Ys[low]>Ys[2]?low:2;var mid=3-low-high;if(high!=low){var x0=Xs[low];var z0=Zs[low];var th0=THs[low];var tv0=TVs[low];var n0=Ns[low]*255;var dy0=Ys[low]-Ys[high];dy0=dy0!=0?dy0:1;var xStep0=(Xs[low]-Xs[high])/dy0;var zStep0=(Zs[low]-Zs[high])/dy0;var thStep0=(THs[low]-THs[high])/dy0;var tvStep0=(TVs[low]-TVs[high])/dy0;var nStep0=(Ns[low]-Ns[high])*255/dy0;var x1=Xs[low];var z1=Zs[low];var th1=THs[low];var tv1=TVs[low];var n1=Ns[low]*255;var dy1=Ys[low]-Ys[mid];dy1=dy1!=0?dy1:1;var xStep1=(Xs[low]-Xs[mid])/dy1;var zStep1=(Zs[low]-Zs[mid])/dy1;var thStep1=(THs[low]-THs[mid])/dy1;var tvStep1=(TVs[low]-TVs[mid])/dy1;var nStep1=(Ns[low]-Ns[mid])*255/dy1;var x2=Xs[mid];var z2=Zs[mid];var th2=THs[mid];var tv2=TVs[mid];var n2=Ns[mid]*255;var dy2=Ys[mid]-Ys[high];dy2=dy2!=0?dy2:1;var xStep2=(Xs[mid]-Xs[high])/dy2;var zStep2=(Zs[mid]-Zs[high])/dy2;var thStep2=(THs[mid]-THs[high])/dy2;var tvStep2=(TVs[mid]-TVs[high])/dy2;var nStep2=(Ns[mid]-Ns[high])*255/dy2;var linebase=Ys[low]*w;for(var y=Ys[low];y>Ys[high];y--){if(y>=0&&y<h){var xLeft=~~x0;var zLeft=z0;var thLeft=th0;var tvLeft=tv0;var nLeft=n0;var xRight,zRight,thRight,tvRight,nRight;if(y>Ys[mid]){xRight=~~x1;zRight=z1;thRight=th1;tvRight=tv1;nRight=n1;}
else{xRight=~~x2;zRight=z2;thRight=th2;tvRight=tv2;nRight=n2;}
if(xLeft>xRight){var temp;temp=xLeft;xLeft=xRight;xRight=temp;temp=zLeft;zLeft=zRight;zRight=temp;temp=thLeft;thLeft=thRight;thRight=temp;temp=tvLeft;tvLeft=tvRight;tvRight=temp;temp=nLeft;nLeft=nRight;nRight=temp;}
var zInc=(xLeft!=xRight)?((zRight-zLeft)/(xRight-xLeft)):1;var thInc=(xLeft!=xRight)?((thRight-thLeft)/(xRight-xLeft)):1;var tvInc=(xLeft!=xRight)?((tvRight-tvLeft)/(xRight-xLeft)):1;var nInc=(xLeft!=xRight)?((nRight-nLeft)/(xRight-xLeft)):0;if(xLeft<0){zLeft-=xLeft*zInc;thLeft-=xLeft*thInc;tvLeft-=xLeft*tvInc;nLeft-=xLeft*nInc;xLeft=0;}
if(xRight>=w)
xRight=w-1;var pix=linebase+xLeft;if(isOpaque){for(var x=xLeft,z=zLeft,n=nLeft,th=thLeft,tv=tvLeft;x<=xRight;x++,z+=zInc,n+=nInc,th+=thInc,tv+=tvInc){if(z>zbuf[pix]){zbuf[pix]=z;var color=palette[n>0?(~~n):0];var texel=tdata[(tv&tbound)*tdim+(th&tbound)];var rr=(((color&0xff0000)>>16)*((texel&0xff0000)>>8));var gg=(((color&0xff00)>>8)*((texel&0xff00)>>8));var bb=((color&0xff)*(texel&0xff))>>8;cbuf[pix]=(rr&0xff0000)|(gg&0xff00)|(bb&0xff);sbuf[pix]=id;}
pix++;}}
else{for(var x=xLeft,z=zLeft,n=nLeft,th=thLeft,tv=tvLeft;x<xRight;x++,z+=zInc,n+=nInc,th+=thInc,tv+=tvInc){if(z>zbuf[pix]){var color=palette[n>0?(~~n):0];var foreColor=tdata[(tv&tbound)*tdim+(th&tbound)];var backColor=cbuf[pix];var opaci=(((foreColor>>24)&0xff)*(matOpacity&0xff))>>8;var rr=(((color&0xff0000)>>16)*((foreColor&0xff0000)>>8));var gg=(((color&0xff00)>>8)*((foreColor&0xff00)>>8));var bb=((color&0xff)*(foreColor&0xff))>>8;if(opaci>250){zbuf[pix]=z;}
else{var trans=255-opaci;rr=(rr*opaci+(backColor&0xff0000)*trans)>>8;gg=(gg*opaci+(backColor&0xff00)*trans)>>8;bb=(bb*opaci+(backColor&0xff)*trans)>>8;}
cbuf[pix]=(rr&0xff0000)|(gg&0xff00)|(bb&0xff);sbuf[pix]=id;}
pix++;}}}
x0-=xStep0;z0-=zStep0;th0-=thStep0;tv0-=tvStep0;n0-=nStep0;if(y>Ys[mid]){x1-=xStep1;z1-=zStep1;th1-=thStep1;tv1-=tvStep1;n1-=nStep1;}
else{x2-=xStep2;z2-=zStep2;th2-=thStep2;tv2-=tvStep2;n2-=nStep2;}
linebase-=w;}}
i1=i2;v1=v2;t1=t2;ni1=ni2;}while(ibuf[j]!=-1);j++;}}};JSC3D.Viewer.prototype.renderSolidSphereMapped=function(mesh){var w=this.frameWidth;var h=this.frameHeight;var ibuf=mesh.indexBuffer;var vbuf=mesh.transformedVertexBuffer;var vnbuf=mesh.transformedVertexNormalBuffer;var vnibuf=mesh.vertexNormalIndexBuffer?mesh.vertexNormalIndexBuffer:mesh.indexBuffer;var fnbuf=mesh.transformedFaceNormalZBuffer;var cbuf=this.colorBuffer;var zbuf=this.zBuffer;var sbuf=this.selectionBuffer;var numOfFaces=mesh.faceCount;var numOfVertices=vbuf.length/3;var id=mesh.internalId;var material=mesh.material?mesh.material:this.defaultMaterial;var palette=material.getPalette();var sphereMap=this.sphereMap;var sdata=sphereMap.data;var sdim=sphereMap.width;var sbound=sdim-1;var isOpaque=material.transparency==0;var trans=material.transparency*255;var opaci=255-trans;var fixForMacSafari=1*null;if(material.transparency==1)
return;if(!vnbuf||vnbuf.length<mesh.vertexNormalBuffer.length){mesh.transformedVertexNormalBuffer=new Array(mesh.vertexNormalBuffer.length);vnbuf=mesh.transformedVertexNormalBuffer;}
if(!fnbuf||fnbuf.length<numOfFaces){mesh.transformedFaceNormalZBuffer=new Array(numOfFaces);fnbuf=mesh.transformedFaceNormalZBuffer;}
JSC3D.Math3D.transformVectors(this.rotMatrix,mesh.vertexNormalBuffer,vnbuf);JSC3D.Math3D.transformVectorZs(this.rotMatrix,mesh.faceNormalBuffer,fnbuf);var isDoubleSided=mesh.isDoubleSided;var Xs=new Array(3);var Ys=new Array(3);var Zs=new Array(3);var NXs=new Array(3);var NYs=new Array(3);var NZs=new Array(3);var i=0,j=0;while(i<numOfFaces){var xformedFNz=fnbuf[i++];if(isDoubleSided)
xformedFNz=xformedFNz>0?xformedFNz:-xformedFNz;if(xformedFNz<0){do{}while(ibuf[j++]!=-1);}
else{var v0,v1,v2;var vn0,vn1,vn2;v0=ibuf[j]*3;vn0=vnibuf[j]*3;j++;v1=ibuf[j]*3;vn1=vnibuf[j]*3;j++
do{v2=ibuf[j]*3;vn2=vnibuf[j]*3;j++
Xs[0]=~~(vbuf[v0]+0.5);Ys[0]=~~(vbuf[v0+1]+0.5);Zs[0]=vbuf[v0+2];Xs[1]=~~(vbuf[v1]+0.5);Ys[1]=~~(vbuf[v1+1]+0.5);Zs[1]=vbuf[v1+2];Xs[2]=~~(vbuf[v2]+0.5);Ys[2]=~~(vbuf[v2+1]+0.5);Zs[2]=vbuf[v2+2];NXs[0]=vnbuf[vn0];NYs[0]=vnbuf[vn0+1];NZs[0]=vnbuf[vn0+2];NXs[1]=vnbuf[vn1];NYs[1]=vnbuf[vn1+1];NZs[1]=vnbuf[vn1+2];NXs[2]=vnbuf[vn2];NYs[2]=vnbuf[vn2+1];NZs[2]=vnbuf[vn2+2];if(isDoubleSided){if(NZs[0]<0)
NZs[0]=-NZs[0];if(NZs[1]<0)
NZs[1]=-NZs[1];if(NZs[2]<0)
NZs[2]=-NZs[2];}
var high=Ys[0]<Ys[1]?0:1;high=Ys[high]<Ys[2]?high:2;var low=Ys[0]>Ys[1]?0:1;low=Ys[low]>Ys[2]?low:2;var mid=3-low-high;if(high!=low){var x0=Xs[low];var z0=Zs[low];var n0=NZs[low]*255;var sh0=((NXs[low]/2+0.5)*sdim)&sbound;var sv0=((0.5-NYs[low]/2)*sdim)&sbound;var dy0=Ys[low]-Ys[high];dy0=dy0!=0?dy0:1;var xStep0=(Xs[low]-Xs[high])/dy0;var zStep0=(Zs[low]-Zs[high])/dy0;var nStep0=(NZs[low]-NZs[high])*255/dy0;var shStep0=(((NXs[low]-NXs[high])/2)*sdim)/dy0;var svStep0=(((NYs[high]-NYs[low])/2)*sdim)/dy0;var x1=Xs[low];var z1=Zs[low];var n1=NZs[low]*255;var sh1=((NXs[low]/2+0.5)*sdim)&sbound;var sv1=((0.5-NYs[low]/2)*sdim)&sbound;var dy1=Ys[low]-Ys[mid];dy1=dy1!=0?dy1:1;var xStep1=(Xs[low]-Xs[mid])/dy1;var zStep1=(Zs[low]-Zs[mid])/dy1;var nStep1=(NZs[low]-NZs[mid])*255/dy1;var shStep1=(((NXs[low]-NXs[mid])/2)*sdim)/dy1;var svStep1=(((NYs[mid]-NYs[low])/2)*sdim)/dy1;var x2=Xs[mid];var z2=Zs[mid];var n2=NZs[mid]*255;var sh2=((NXs[mid]/2+0.5)*sdim)&sbound;var sv2=((0.5-NYs[mid]/2)*sdim)&sbound;var dy2=Ys[mid]-Ys[high];dy2=dy2!=0?dy2:1;var xStep2=(Xs[mid]-Xs[high])/dy2;var zStep2=(Zs[mid]-Zs[high])/dy2;var nStep2=(NZs[mid]-NZs[high])*255/dy2;var shStep2=(((NXs[mid]-NXs[high])/2)*sdim)/dy2;var svStep2=(((NYs[high]-NYs[mid])/2)*sdim)/dy2;var linebase=Ys[low]*w;for(var y=Ys[low];y>Ys[high];y--){if(y>=0&&y<h){var xLeft=~~x0;var zLeft=z0;var nLeft=n0;var shLeft=sh0;var svLeft=sv0;var xRight,zRight,nRight,shRight,svRight;if(y>Ys[mid]){xRight=~~x1;zRight=z1;nRight=n1;shRight=sh1;svRight=sv1;}
else{xRight=~~x2;zRight=z2;nRight=n2;shRight=sh2;svRight=sv2;}
if(xLeft>xRight){var temp;temp=xLeft;xLeft=xRight;xRight=temp;temp=zLeft;zLeft=zRight;zRight=temp;temp=nLeft;nLeft=nRight;nRight=temp;temp=shLeft;shLeft=shRight;shRight=temp;temp=svLeft;svLeft=svRight;svRight=temp;}
var zInc=(xLeft!=xRight)?((zRight-zLeft)/(xRight-xLeft)):1;var nInc=(xLeft!=xRight)?((nRight-nLeft)/(xRight-xLeft)):1;var shInc=(xLeft!=xRight)?((shRight-shLeft)/(xRight-xLeft)):1;var svInc=(xLeft!=xRight)?((svRight-svLeft)/(xRight-xLeft)):1;if(xLeft<0){zLeft-=xLeft*zInc;nLeft-=xLeft*nInc;shLeft-=shLeft*shInc;svLeft-=svLeft*svInc;xLeft=0;}
if(xRight>=w){xRight=w-1;}
var pix=linebase+xLeft;if(isOpaque){for(var x=xLeft,z=zLeft,n=nLeft,sh=shLeft,sv=svLeft;x<=xRight;x++,z+=zInc,n+=nInc,sh+=shInc,sv+=svInc){if(z>zbuf[pix]){zbuf[pix]=z;var color=palette[n>0?(~~n):0];var stexel=sdata[(sv&sbound)*sdim+(sh&sbound)];var rr=(((color&0xff0000)>>16)*((stexel&0xff0000)>>8));var gg=(((color&0xff00)>>8)*((stexel&0xff00)>>8));var bb=((color&0xff)*(stexel&0xff))>>8;cbuf[pix]=(rr&0xff0000)|(gg&0xff00)|(bb&0xff);sbuf[pix]=id;}
pix++;}}
else{for(var x=xLeft,z=zLeft,n=nLeft,sh=shLeft,sv=svLeft;x<xRight;x++,z+=zInc,n+=nInc,sh+=shInc,sv+=svInc){if(z>zbuf[pix]){var color=palette[n>0?(~~n):0];var foreColor=sdata[(sv&sbound)*sdim+(sh&sbound)];var backColor=cbuf[pix];var rr=(((color&0xff0000)>>16)*((foreColor&0xff0000)>>8));var gg=(((color&0xff00)>>8)*((foreColor&0xff00)>>8));var bb=((color&0xff)*(foreColor&0xff))>>8;rr=(rr*opaci+(backColor&0xff0000)*trans)>>8;gg=(gg*opaci+(backColor&0xff00)*trans)>>8;bb=(bb*opaci+(backColor&0xff)*trans)>>8;cbuf[pix]=(rr&0xff0000)|(gg&0xff00)|(bb&0xff);sbuf[pix]=id;}
pix++;}}}
x0-=xStep0;z0-=zStep0;n0-=nStep0;sh0-=shStep0;sv0-=svStep0;if(y>Ys[mid]){x1-=xStep1;z1-=zStep1;n1-=nStep1;sh1-=shStep1;sv1-=svStep1;}
else{x2-=xStep2;z2-=zStep2;n2-=nStep2;sh2-=shStep2;sv2-=svStep2;}
linebase-=w;}}
v1=v2;vn1=vn2;}while(ibuf[j]!=-1);j++;}}};JSC3D.Viewer.prototype.params=null;JSC3D.Viewer.prototype.canvas=null;JSC3D.Viewer.prototype.ctx2d=null;JSC3D.Viewer.prototype.canvasData=null;JSC3D.Viewer.prototype.bkgColorBuffer=null;JSC3D.Viewer.prototype.colorBuffer=null;JSC3D.Viewer.prototype.zBuffer=null;JSC3D.Viewer.prototype.selectionBuffer=null;JSC3D.Viewer.prototype.frameWidth=0;JSC3D.Viewer.prototype.frameHeight=0;JSC3D.Viewer.prototype.scene=null;JSC3D.Viewer.prototype.defaultMaterial=null;JSC3D.Viewer.prototype.sphereMap=null;JSC3D.Viewer.prototype.isLoaded=false;JSC3D.Viewer.prototype.isFailed=false;JSC3D.Viewer.prototype.needUpdate=false;JSC3D.Viewer.prototype.needRepaint=false;JSC3D.Viewer.prototype.initRotX=0;JSC3D.Viewer.prototype.initRotY=0;JSC3D.Viewer.prototype.initRotZ=0;JSC3D.Viewer.prototype.zoomFactor=1;JSC3D.Viewer.prototype.panning=[0,0];JSC3D.Viewer.prototype.rotMatrix=null;JSC3D.Viewer.prototype.transformMatrix=null;JSC3D.Viewer.prototype.sceneUrl='';JSC3D.Viewer.prototype.modelColor=0xcaa618;JSC3D.Viewer.prototype.bkgColor1=0xffffff;JSC3D.Viewer.prototype.bkgColor2=0xffff80;JSC3D.Viewer.prototype.renderMode='flat';JSC3D.Viewer.prototype.definition='standard';JSC3D.Viewer.prototype.isMipMappingOn=false;JSC3D.Viewer.prototype.creaseAngle=-180;JSC3D.Viewer.prototype.sphereMapUrl='';JSC3D.Viewer.prototype.showProgressBar=true;JSC3D.Viewer.prototype.buttonStates=null;JSC3D.Viewer.prototype.keyStates=null;JSC3D.Viewer.prototype.mouseX=0;JSC3D.Viewer.prototype.mouseY=0;JSC3D.Viewer.prototype.onloadingstarted=null;JSC3D.Viewer.prototype.onloadingcomplete=null;JSC3D.Viewer.prototype.onloadingprogress=null;JSC3D.Viewer.prototype.onloadingaborted=null;JSC3D.Viewer.prototype.onloadingerror=null;JSC3D.Viewer.prototype.onmousedown=null;JSC3D.Viewer.prototype.onmouseup=null;JSC3D.Viewer.prototype.onmousemove=null;JSC3D.Viewer.prototype.onmousewheel=null;JSC3D.Viewer.prototype.beforeupdate=null;JSC3D.Viewer.prototype.afterupdate=null;JSC3D.Viewer.prototype.mouseUsage='default';JSC3D.Viewer.prototype.isDefaultInputHandlerEnabled=false;JSC3D.PickInfo=function(){this.canvasX=0;this.canvasY=0;this.depth=-Infinity;this.mesh=null;};JSC3D.Scene=function(name){this.name=name||'';this.aabb=null;this.children=[];this.maxChildId=1;};JSC3D.Scene.prototype.init=function(){if(this.isEmpty())
return;for(var i=0;i<this.children.length;i++)
this.children[i].init();if(!this.aabb){this.aabb=new JSC3D.AABB;this.calcAABB();}};JSC3D.Scene.prototype.isEmpty=function(){return(this.children.length==0);};JSC3D.Scene.prototype.addChild=function(mesh){mesh.internalId=this.maxChildId++;this.children.push(mesh);};JSC3D.Scene.prototype.removeChild=function(mesh){var foundAt=this.children.indexOf(mesh);if(foundAt>=0)
this.children.splice(foundAt,1);};JSC3D.Scene.prototype.getChildren=function(){return this.children.slice(0);};JSC3D.Scene.prototype.forEachChild=function(operator){if((typeof operator)!='function')
return;for(var i=0;i<this.children.length;i++){if(operator.call(null,this.children[i]))
break;}};JSC3D.Scene.prototype.calcAABB=function(){this.aabb.minX=this.aabb.minY=this.aabb.minZ=Number.MAX_VALUE;this.aabb.maxX=this.aabb.maxY=this.aabb.maxZ=-Number.MAX_VALUE;for(var i=0;i<this.children.length;i++){var child=this.children[i];if(!child.isTrivial()){var minX=child.aabb.minX;var minY=child.aabb.minY;var minZ=child.aabb.minZ;var maxX=child.aabb.maxX;var maxY=child.aabb.maxY;var maxZ=child.aabb.maxZ;if(this.aabb.minX>minX)
this.aabb.minX=minX;if(this.aabb.minY>minY)
this.aabb.minY=minY;if(this.aabb.minZ>minZ)
this.aabb.minZ=minZ;if(this.aabb.maxX<maxX)
this.aabb.maxX=maxX;if(this.aabb.maxY<maxY)
this.aabb.maxY=maxY;if(this.aabb.maxZ<maxZ)
this.aabb.maxZ=maxZ;}}};JSC3D.Scene.prototype.name='';JSC3D.Scene.prototype.aabb=null;JSC3D.Scene.prototype.children=null;JSC3D.Scene.prototype.maxChildId=1;JSC3D.Mesh=function(name,visible,material,texture,creaseAngle,isDoubleSided,isEnvironmentCast,coordBuffer,indexBuffer,texCoordBuffer,texCoordIndexBuffer){this.name=name||'';this.metadata='';this.visible=(visible!=undefined)?visible:true;this.renderMode=null;this.aabb=null;this.vertexBuffer=coordBuffer||null;this.indexBuffer=indexBuffer||null;this.vertexNormalBuffer=null;this.vertexNormalIndexBuffer=null;this.faceNormalBuffer=null;this.material=material||null;this.texture=texture||null;this.faceCount=0;this.creaseAngle=(creaseAngle>=0)?creaseAngle:-180;this.isDoubleSided=isDoubleSided||false;this.isEnvironmentCast=isEnvironmentCast||false;this.internalId=0;this.texCoordBuffer=texCoordBuffer||null;this.texCoordIndexBuffer=texCoordIndexBuffer||null;this.transformedVertexBuffer=null;this.transformedVertexNormalZBuffer=null;this.transformedFaceNormalZBuffer=null;this.transformedVertexNormalBuffer=null;};JSC3D.Mesh.prototype.init=function(){if(this.isTrivial()){return;}
if(this.faceCount==0){this.calcFaceCount();if(this.faceCount==0)
return;}
if(!this.aabb){this.aabb=new JSC3D.AABB;this.calcAABB();}
if(!this.faceNormalBuffer){this.faceNormalBuffer=new Array(this.faceCount*3);this.calcFaceNormals();}
if(!this.vertexNormalBuffer){if(this.creaseAngle>=0){this.calcCreasedVertexNormals();}
else{this.vertexNormalBuffer=new Array(this.vertexBuffer.length);this.calcVertexNormals();}}
this.normalizeFaceNormals();this.transformedVertexBuffer=new Array(this.vertexBuffer.length);};JSC3D.Mesh.prototype.isTrivial=function(){return(!this.vertexBuffer||this.vertexBuffer.length<3||!this.indexBuffer||this.indexBuffer.length<3);};JSC3D.Mesh.prototype.setMaterial=function(material){this.material=material;};JSC3D.Mesh.prototype.setTexture=function(texture){this.texture=texture;};JSC3D.Mesh.prototype.hasTexture=function(){return((this.texture!=null)&&this.texture.hasData()&&(this.texCoordBuffer!=null)&&(this.texCoordBuffer.length>=2)&&((this.texCoordIndexBuffer==null)||((this.texCoordIndexBuffer.length>=3)&&(this.texCoordIndexBuffer.length>=this.indexBuffer.length))));};JSC3D.Mesh.prototype.setRenderMode=function(mode){this.renderMode=mode;};JSC3D.Mesh.prototype.calcFaceCount=function(){this.faceCount=0;var ibuf=this.indexBuffer;if(ibuf[ibuf.length-1]!=-1)
ibuf.push(-1);for(var i=0;i<ibuf.length;i++){if(ibuf[i]==-1)
this.faceCount++;}};JSC3D.Mesh.prototype.calcAABB=function(){var minX=minY=minZ=Number.MAX_VALUE;var maxX=maxY=maxZ=-Number.MAX_VALUE;var vbuf=this.vertexBuffer;for(var i=0;i<vbuf.length;i+=3){var x=vbuf[i];var y=vbuf[i+1];var z=vbuf[i+2];if(x<minX)
minX=x;if(x>maxX)
maxX=x;if(y<minY)
minY=y;if(y>maxY)
maxY=y;if(z<minZ)
minZ=z;if(z>maxZ)
maxZ=z;}
this.aabb.minX=minX;this.aabb.minY=minY;this.aabb.minZ=minZ;this.aabb.maxX=maxX;this.aabb.maxY=maxY;this.aabb.maxZ=maxZ;};JSC3D.Mesh.prototype.calcFaceNormals=function(){var vbuf=this.vertexBuffer;var ibuf=this.indexBuffer;var nbuf=this.faceNormalBuffer;var i=0,j=0;while(i<ibuf.length){var index=ibuf[i++]*3;var x0=vbuf[index];var y0=vbuf[index+1];var z0=vbuf[index+2];index=ibuf[i++]*3;var x1=vbuf[index];var y1=vbuf[index+1];var z1=vbuf[index+2];index=ibuf[i++]*3;var x2=vbuf[index];var y2=vbuf[index+1];var z2=vbuf[index+2];var dx1=x1-x0;var dy1=y1-y0;var dz1=z1-z0;var dx2=x2-x0;var dy2=y2-y0;var dz2=z2-z0;var nx=dy1*dz2-dz1*dy2;var ny=dz1*dx2-dx1*dz2;var nz=dx1*dy2-dy1*dx2;nbuf[j++]=nx;nbuf[j++]=ny;nbuf[j++]=nz;do{}while(ibuf[i++]!=-1);}};JSC3D.Mesh.prototype.normalizeFaceNormals=function(){JSC3D.Math3D.normalizeVectors(this.faceNormalBuffer,this.faceNormalBuffer);};JSC3D.Mesh.prototype.calcVertexNormals=function(){if(!this.faceNormalBuffer){this.faceNormalBuffer=new Array(this.faceCount*3);this.calcFaceNormals();}
var vbuf=this.vertexBuffer;var ibuf=this.indexBuffer;var fnbuf=this.faceNormalBuffer;var vnbuf=this.vertexNormalBuffer;for(var i=0;i<vnbuf.length;i++){vnbuf[i]=0;}
this.vertexNormalIndexBuffer=null;var numOfVertices=vbuf.length/3;var i=0,j=0,k=0;while(i<ibuf.length){k=ibuf[i++];if(k==-1){j+=3;}
else{var index=k*3;vnbuf[index]+=fnbuf[j];vnbuf[index+1]+=fnbuf[j+1];vnbuf[index+2]+=fnbuf[j+2];}}
JSC3D.Math3D.normalizeVectors(vnbuf,vnbuf);};JSC3D.Mesh.prototype.calcCreasedVertexNormals=function(){if(!this.faceNormalBuffer){this.faceNormalBuffer=new Array(this.faceCount*3);this.calcFaceNormals();}
var ibuf=this.indexBuffer;var numOfVerts=this.vertexBuffer.length/3;var vertTouchedFaces=new Array(numOfVerts);var expectedVertNormalBufferLength=0;for(var i=0,findex=0,vindex=0;i<ibuf.length;i++){vindex=ibuf[i];if(vindex>=0){expectedVertNormalBufferLength+=3;var faces=vertTouchedFaces[vindex];if(!faces)
vertTouchedFaces[vindex]=[findex];else
faces.push(findex);}
else{findex++;}}
var fnbuf=this.faceNormalBuffer;var nfnbuf=new Array(fnbuf.length);JSC3D.Math3D.normalizeVectors(fnbuf,nfnbuf);if(!this.vertexNormalBuffer||this.vertexNormalBuffer.length<expectedVertNormalBufferLength)
this.vertexNormalBuffer=new Array(expectedVertNormalBufferLength);var vnbuf=this.vertexNormalBuffer;for(var i=0;i<vnbuf.length;i++){vnbuf[i]=0;}
this.vertexNormalIndexBuffer=[];var nibuf=this.vertexNormalIndexBuffer;var threshold=Math.cos(this.creaseAngle*Math.PI/180);for(var i=0,vindex=0,nindex=0,findex0=0;i<ibuf.length;i++){vindex=ibuf[i];if(vindex>=0){var n=nindex*3;var f0=findex0*3;vnbuf[n]+=fnbuf[f0];vnbuf[n+1]+=fnbuf[f0+1];vnbuf[n+2]+=fnbuf[f0+2];var fnx0=nfnbuf[f0];var fny0=nfnbuf[f0+1];var fnz0=nfnbuf[f0+2];var faces=vertTouchedFaces[vindex];for(var j=0;j<faces.length;j++){var findex1=faces[j];if(findex0!=findex1){var f1=findex1*3;var fnx1=nfnbuf[f1];var fny1=nfnbuf[f1+1];var fnz1=nfnbuf[f1+2];if(fnx0*fnx1+fny0*fny1+fnz0*fnz1>threshold){vnbuf[n]+=fnbuf[f1];vnbuf[n+1]+=fnbuf[f1+1];vnbuf[n+2]+=fnbuf[f1+2];}}}
nibuf.push(nindex++);}
else{findex0++;nibuf.push(-1);}}
JSC3D.Math3D.normalizeVectors(vnbuf,vnbuf);};JSC3D.Mesh.prototype.checkValid=function(){};JSC3D.Mesh.prototype.name='';JSC3D.Mesh.prototype.metadata='';JSC3D.Mesh.prototype.visible=false;JSC3D.Mesh.prototype.renderMode='flat';JSC3D.Mesh.prototype.aabb=null;JSC3D.Mesh.prototype.vertexBuffer=null;JSC3D.Mesh.prototype.indexBuffer=null;JSC3D.Mesh.prototype.vertexNormalBuffer=null;JSC3D.Mesh.prototype.vertexNormalIndexBuffer=null;JSC3D.Mesh.prototype.faceNormalBuffer=null;JSC3D.Mesh.prototype.texCoordBuffer=null;JSC3D.Mesh.prototype.texCoordIndexBuffer=null;JSC3D.Mesh.prototype.material=null;JSC3D.Mesh.prototype.texture=null;JSC3D.Mesh.prototype.faceCount=0;JSC3D.Mesh.prototype.creaseAngle=-180;JSC3D.Mesh.prototype.isDoubleSided=false;JSC3D.Mesh.prototype.isEnvironmentCast=false;JSC3D.Mesh.prototype.internalId=0;JSC3D.Mesh.prototype.transformedVertexBuffer=null;JSC3D.Mesh.prototype.transformedVertexNormalZBuffer=null;JSC3D.Mesh.prototype.transformedFaceNormalZBuffer=null;JSC3D.Mesh.prototype.transformedVertexNormalBuffer=null;JSC3D.Material=function(name,ambientColor,diffuseColor,transparency,simulateSpecular){this.name=name||'';this.ambientColor=ambientColor||0;this.diffuseColor=diffuseColor||0x7f7f7f;this.transparency=transparency||0;this.simulateSpecular=simulateSpecular||false;this.palette=null;};JSC3D.Material.prototype.getPalette=function(){if(!this.palette){this.palette=new Array(256);this.generatePalette();}
return this.palette;};JSC3D.Material.prototype.generatePalette=function(){var ambientR=(this.ambientColor&0xff0000)>>16;var ambientG=(this.ambientColor&0xff00)>>8;var ambientB=this.ambientColor&0xff;var diffuseR=(this.diffuseColor&0xff0000)>>16;var diffuseG=(this.diffuseColor&0xff00)>>8;var diffuseB=this.diffuseColor&0xff;if(this.simulateSpecular){var i=0;while(i<204){var r=ambientR+i*diffuseR/204;var g=ambientG+i*diffuseG/204;var b=ambientB+i*diffuseB/204;if(r>255)
r=255;if(g>255)
g=255;if(b>255)
b=255;this.palette[i++]=r<<16|g<<8|b;}
while(i<256){var r=ambientR+diffuseR+(i-204)*(255-diffuseR)/82;var g=ambientG+diffuseG+(i-204)*(255-diffuseG)/82;var b=ambientB+diffuseB+(i-204)*(255-diffuseB)/82;if(r>255)
r=255;if(g>255)
g=255;if(b>255)
b=255;this.palette[i++]=r<<16|g<<8|b;}}
else{var i=0;while(i<256){var r=ambientR+i*diffuseR/256;var g=ambientG+i*diffuseG/256;var b=ambientB+i*diffuseB/256;if(r>255)
r=255;if(g>255)
g=255;if(b>255)
b=255;this.palette[i++]=r<<16|g<<8|b;}}};JSC3D.Material.prototype.name='';JSC3D.Material.prototype.ambientColor=0;JSC3D.Material.prototype.diffuseColor=0x7f7f7f;JSC3D.Material.prototype.transparency=0;JSC3D.Material.prototype.simulateSpecular=false;JSC3D.Material.prototype.palette=null;JSC3D.Texture=function(name,onready){this.name=name||'';this.width=0;this.height=0;this.data=null;this.mipmaps=null;this.mipentries=null;this.hasTransparency=false;this.srcUrl='';this.onready=(onready&&typeof(onready)=='function')?onready:null;};JSC3D.Texture.prototype.createFromUrl=function(imageUrl,useMipmap){var self=this;var img=new Image;img.onload=function(){self.data=null;self.mipmaps=null;self.mipentries=null;self.width=0;self.height=0;self.hasTransparency=false;self.srcUrl='';self.createFromImage(this,useMipmap);if(JSC3D.console)
JSC3D.console.logInfo('Finished loading texture image file "'+this.src+'".');};img.onerror=function(){self.data=null;self.mipmaps=null;self.mipentries=null;self.width=0;self.height=0;self.hasTransparency=false;self.srcUrl='';if(JSC3D.console)
JSC3D.console.logWarning('Failed to load texture image file "'+this.src+'". This texture will be discarded.');};img.src=imageUrl;};JSC3D.Texture.prototype.createFromImage=function(image,useMipmap){if(image.width<=0||image.height<=0)
return;var isCanvasClean=false;var canvas=JSC3D.Texture.cv;if(!canvas){try{canvas=document.createElement('canvas');JSC3D.Texture.cv=canvas;isCanvasClean=true;}
catch(e){return;}}
var dim=image.width>image.height?image.width:image.height;if(dim<=32)
dim=32;else if(dim<=64)
dim=64;else if(dim<=128)
dim=128;else if(dim<=256)
dim=256;else if(dim<=512)
dim=512;else
dim=1024;if(canvas.width!=dim||canvas.height!=dim){canvas.width=canvas.height=dim;isCanvasClean=true;}
var data;try{var ctx=canvas.getContext('2d');if(!isCanvasClean)
ctx.clearRect(0,0,dim,dim);ctx.drawImage(image,0,0,dim,dim);var imgData=ctx.getImageData(0,0,dim,dim);data=imgData.data;}
catch(e){return;}
var size=data.length/4;this.data=new Array(size);var alpha;for(var i=0,j=0;i<size;i++,j+=4){alpha=data[j+3];this.data[i]=alpha<<24|data[j]<<16|data[j+1]<<8|data[j+2];if(alpha<255)
this.hasTransparency=true;}
this.width=dim;this.height=dim;this.mipmaps=null;if(useMipmap)
this.generateMipmaps();this.srcUrl=image.src;if(this.onready!=null&&(typeof this.onready)=='function')
this.onready();};JSC3D.Texture.prototype.hasData=function(){return(this.data!=null);};JSC3D.Texture.prototype.generateMipmaps=function(){if(this.width<=1||this.data==null||this.mipmaps!=null)
return;this.mipmaps=[this.data];this.mipentries=[1];var numOfMipLevels=1+~~(0.1+Math.log(this.width)*Math.LOG2E);var dim=this.width>>1;for(var level=1;level<numOfMipLevels;level++){var map=new Array(dim*dim);var uppermap=this.mipmaps[level-1];var upperdim=dim<<1;var src=0,dest=0;for(var i=0;i<dim;i++){for(var j=0;j<dim;j++){var texel0=uppermap[src];var texel1=uppermap[src+1];var texel2=uppermap[src+upperdim];var texel3=uppermap[src+upperdim+1];var a=(((texel0&0xff000000)>>>2)+((texel1&0xff000000)>>>2)+((texel2&0xff000000)>>>2)+((texel3&0xff000000)>>>2))&0xff000000;var r=(((texel0&0xff0000)+(texel1&0xff0000)+(texel2&0xff0000)+(texel3&0xff0000))>>2)&0xff0000;var g=(((texel0&0xff00)+(texel1&0xff00)+(texel2&0xff00)+(texel3&0xff00))>>2)&0xff00;var b=(((texel0&0xff)+(texel1&0xff)+(texel2&0xff)+(texel3&0xff))>>2)&0xff;map[dest]=a+r+g+b;src+=2;dest++;}
src+=upperdim;}
this.mipmaps.push(map);this.mipentries.push(Math.pow(4,level));dim=dim>>1;}};JSC3D.Texture.prototype.hasMipmap=function(){return(this.mipmaps!=null);};JSC3D.Texture.prototype.name='';JSC3D.Texture.prototype.data=null;JSC3D.Texture.prototype.mipmaps=null;JSC3D.Texture.prototype.mipentries=null;JSC3D.Texture.prototype.width=0;JSC3D.Texture.prototype.height=0;JSC3D.Texture.prototype.hasTransparency=false;JSC3D.Texture.prototype.srcUrl='';JSC3D.Texture.prototype.onready=null;JSC3D.Texture.cv=null;JSC3D.AABB=function(){this.minX=this.maxX=0;this.minY=this.maxY=0;this.minZ=this.maxZ=0;};JSC3D.AABB.prototype.center=function(){return[(this.minX+this.maxX)/2,(this.minY+this.maxY)/2,(this.minZ+this.maxZ)/2];};JSC3D.AABB.prototype.lengthOfDiagonal=function(){var xx=this.maxX-this.minX;var yy=this.maxY-this.minY;var zz=this.maxZ-this.minZ;return Math.sqrt(xx*xx+yy*yy+zz*zz);};JSC3D.Matrix3x4=function(){this.m00=1;this.m01=0;this.m02=0;this.m03=0;this.m10=0;this.m11=1;this.m12=0;this.m13=0;this.m20=0;this.m21=0;this.m22=1;this.m23=0;};JSC3D.Matrix3x4.prototype.identity=function(){this.m00=1;this.m01=0;this.m02=0;this.m03=0;this.m10=0;this.m11=1;this.m12=0;this.m13=0;this.m20=0;this.m21=0;this.m22=1;this.m23=0;};JSC3D.Matrix3x4.prototype.scale=function(sx,sy,sz){this.m00*=sx;this.m01*=sx;this.m02*=sx;this.m03*=sx;this.m10*=sy;this.m11*=sy;this.m12*=sy;this.m13*=sy;this.m20*=sz;this.m21*=sz;this.m22*=sz;this.m23*=sz;};JSC3D.Matrix3x4.prototype.translate=function(tx,ty,tz){this.m03+=tx;this.m13+=ty;this.m23+=tz;};JSC3D.Matrix3x4.prototype.rotateAboutXAxis=function(angle){if(angle!=0){angle*=Math.PI/180;var cosA=Math.cos(angle);var sinA=Math.sin(angle);var m10=cosA*this.m10-sinA*this.m20;var m11=cosA*this.m11-sinA*this.m21;var m12=cosA*this.m12-sinA*this.m22;var m13=cosA*this.m13-sinA*this.m23;var m20=cosA*this.m20+sinA*this.m10;var m21=cosA*this.m21+sinA*this.m11;var m22=cosA*this.m22+sinA*this.m12;var m23=cosA*this.m23+sinA*this.m13;this.m10=m10;this.m11=m11;this.m12=m12;this.m13=m13;this.m20=m20;this.m21=m21;this.m22=m22;this.m23=m23;}};JSC3D.Matrix3x4.prototype.rotateAboutYAxis=function(angle){if(angle!=0){angle*=Math.PI/180;var cosA=Math.cos(angle);var sinA=Math.sin(angle);var m00=cosA*this.m00+sinA*this.m20;var m01=cosA*this.m01+sinA*this.m21;var m02=cosA*this.m02+sinA*this.m22;var m03=cosA*this.m03+sinA*this.m23;var m20=cosA*this.m20-sinA*this.m00;var m21=cosA*this.m21-sinA*this.m01;var m22=cosA*this.m22-sinA*this.m02;var m23=cosA*this.m23-sinA*this.m03;this.m00=m00;this.m01=m01;this.m02=m02;this.m03=m03;this.m20=m20;this.m21=m21;this.m22=m22;this.m23=m23;}};JSC3D.Matrix3x4.prototype.rotateAboutZAxis=function(angle){if(angle!=0){angle*=Math.PI/180;var cosA=Math.cos(angle);var sinA=Math.sin(angle);var m10=cosA*this.m10+sinA*this.m00;var m11=cosA*this.m11+sinA*this.m01;var m12=cosA*this.m12+sinA*this.m02;var m13=cosA*this.m13+sinA*this.m03;var m00=cosA*this.m00-sinA*this.m10;var m01=cosA*this.m01-sinA*this.m11;var m02=cosA*this.m02-sinA*this.m12;var m03=cosA*this.m03-sinA*this.m13;this.m00=m00;this.m01=m01;this.m02=m02;this.m03=m03;this.m10=m10;this.m11=m11;this.m12=m12;this.m13=m13;}};JSC3D.Matrix3x4.prototype.multiply=function(mult){var m00=mult.m00*this.m00+mult.m01*this.m10+mult.m02*this.m20;var m01=mult.m00*this.m01+mult.m01*this.m11+mult.m02*this.m21;var m02=mult.m00*this.m02+mult.m01*this.m12+mult.m02*this.m22;var m03=mult.m00*this.m03+mult.m01*this.m13+mult.m02*this.m23+mult.m03;var m10=mult.m10*this.m00+mult.m11*this.m10+mult.m12*this.m20;var m11=mult.m10*this.m01+mult.m11*this.m11+mult.m12*this.m21;var m12=mult.m10*this.m02+mult.m11*this.m12+mult.m12*this.m22;var m13=mult.m10*this.m03+mult.m11*this.m13+mult.m12*this.m23+mult.m13;var m20=mult.m20*this.m00+mult.m21*this.m10+mult.m22*this.m20;var m21=mult.m20*this.m01+mult.m21*this.m11+mult.m22*this.m21;var m22=mult.m20*this.m02+mult.m21*this.m12+mult.m22*this.m22;var m23=mult.m20*this.m03+mult.m21*this.m13+mult.m22*this.m23+mult.m23;this.m00=m00;this.m01=m01;this.m02=m02;this.m03=m03;this.m10=m10;this.m11=m11;this.m12=m12;this.m13=m13;this.m20=m20;this.m21=m21;this.m22=m22;this.m23=m23;};JSC3D.Math3D={transformVectors:function(mat,vecs,xfvecs){for(var i=0;i<vecs.length;i+=3){var x=vecs[i];var y=vecs[i+1];var z=vecs[i+2];xfvecs[i]=mat.m00*x+mat.m01*y+mat.m02*z+mat.m03;xfvecs[i+1]=mat.m10*x+mat.m11*y+mat.m12*z+mat.m13;xfvecs[i+2]=mat.m20*x+mat.m21*y+mat.m22*z+mat.m23;}},transformVectorZs:function(mat,vecs,xfveczs){var num=vecs.length/3;var i=0,j=0
while(i<num){xfveczs[i]=mat.m20*vecs[j]+mat.m21*vecs[j+1]+mat.m22*vecs[j+2]+mat.m23;i++;j+=3;}},normalizeVectors:function(src,dest){var num=src.length;for(var i=0;i<num;i+=3){var x=src[i];var y=src[i+1];var z=src[i+2];var len=Math.sqrt(x*x+y*y+z*z);if(len>0){len=1/len;x*=len;y*=len;z*=len;}
dest[i]=x;dest[i+1]=y;dest[i+2]=z;}}};JSC3D.PlatformInfo=(function(){var info={browser:'other',version:'n/a',isTouchDevice:(document.createTouch!=undefined),supportTypedArrays:(window.Uint32Array!=undefined),supportWebGL:(window.WebGLRenderingContext!=undefined)};var agents=[['firefox',/Firefox[\/\s](\d+(?:\.\d+)*)/],['chrome',/Chrome[\/\s](\d+(?:\.\d+)*)/],['opera',/Opera[\/\s](\d+(?:\.\d+)*)/],['safari',/Safari[\/\s](\d+(?:\.\d+)*)/],['webkit',/AppleWebKit[\/\s](\d+(?:\.\d+)*)/],['ie',/MSIE[\/\s](\d+(?:\.\d+)*)/],['ie',/Trident\/\d+\.\d+;\s.*rv:(\d+(?:\.\d+)*)/]];var matches;for(var i=0;i<agents.length;i++){if((matches=agents[i][1].exec(window.navigator.userAgent))){info.browser=agents[i][0];info.version=matches[1];break;}}
return info;})();JSC3D.BinaryStream=function(data,isBigEndian){if(isBigEndian)
throw'JSC3D.BinaryStream constructor failed: Big endian is not supported yet!';this.data=data;this.offset=0;};JSC3D.BinaryStream.prototype.size=function(){return this.data.length;};JSC3D.BinaryStream.prototype.tell=function(){return this.offset;};JSC3D.BinaryStream.prototype.seek=function(position){if(position<0||position>=this.data.length)
return false;this.offset=position;return true;};JSC3D.BinaryStream.prototype.reset=function(){this.offset=0;};JSC3D.BinaryStream.prototype.skip=function(bytesToSkip){if(this.offset+bytesToSkip>this.data.length)
this.offset=this.data.length;else
this.offset+=bytesToSkip;};JSC3D.BinaryStream.prototype.available=function(){return this.data.length-this.offset;};JSC3D.BinaryStream.prototype.eof=function(){return!(this.offset<this.data.length);};JSC3D.BinaryStream.prototype.readUInt8=function(){return this.decodeInt(1,false);};JSC3D.BinaryStream.prototype.readInt8=function(){return this.decodeInt(1,true);};JSC3D.BinaryStream.prototype.readUInt16=function(){return this.decodeInt(2,false);};JSC3D.BinaryStream.prototype.readInt16=function(){return this.decodeInt(2,true);};JSC3D.BinaryStream.prototype.readUInt32=function(){return this.decodeInt(4,false);};JSC3D.BinaryStream.prototype.readInt32=function(){return this.decodeInt(4,true);};JSC3D.BinaryStream.prototype.readFloat32=function(){return this.decodeFloat(4,23);};JSC3D.BinaryStream.prototype.readFloat64=function(){return this.decodeFloat(8,52);};JSC3D.BinaryStream.prototype.readBytes=function(buffer,bytesToRead){var bytesRead=bytesToRead;if(this.offset+bytesToRead>this.data.length)
bytesRead=this.data.length-this.offset;for(var i=0;i<bytesRead;i++){buffer[i]=this.data[this.offset++].charCodeAt(0)&0xff;}
return bytesRead;};JSC3D.BinaryStream.prototype.decodeInt=function(bytes,isSigned){if(this.offset+bytes>this.data.length){this.offset=this.data.length;return NaN;}
var rv=0,f=1;for(var i=0;i<bytes;i++){rv+=((this.data[this.offset++].charCodeAt(0)&0xff)*f);f*=256;}
if(isSigned&&(rv&Math.pow(2,bytes*8-1)))
rv-=Math.pow(2,bytes*8);return rv;};JSC3D.BinaryStream.prototype.decodeFloat=function(bytes,significandBits){if(this.offset+bytes>this.data.length){this.offset=this.data.length;return NaN;}
var mLen=significandBits;var eLen=bytes*8-mLen-1;var eMax=(1<<eLen)-1;var eBias=eMax>>1;var i=bytes-1;var d=-1;var s=this.data[this.offset+i].charCodeAt(0)&0xff;i+=d;var bits=-7;var e=s&((1<<(-bits))-1);s>>=-bits;bits+=eLen
while(bits>0){e=e*256+(this.data[this.offset+i].charCodeAt(0)&0xff);i+=d;bits-=8;}
var m=e&((1<<(-bits))-1);e>>=-bits;bits+=mLen;while(bits>0){m=m*256+(this.data[this.offset+i].charCodeAt(0)&0xff);i+=d;bits-=8;}
this.offset+=bytes;switch(e){case 0:e=1-eBias;break;case eMax:return m?NaN:((s?-1:1)*Infinity);default:m+=Math.pow(2,mLen);e-=eBias;break;}
return(s?-1:1)*m*Math.pow(2,e-mLen);};JSC3D.LoaderSelector={registerLoader:function(fileExtName,loaderCtor){if((typeof loaderCtor)=='function'){JSC3D.LoaderSelector.loaderTable[fileExtName]=loaderCtor;}},getLoader:function(fileExtName){var loaderCtor=JSC3D.LoaderSelector.loaderTable[fileExtName.toLowerCase()];if(!loaderCtor)
return null;var loaderInst;try{loaderInst=new loaderCtor();}
catch(e){loaderInst=null;}
return loaderInst;},loaderTable:{}};JSC3D.ObjLoader=function(onload,onerror,onprogress,onresource){this.onload=(onload&&typeof(onload)=='function')?onload:null;this.onerror=(onerror&&typeof(onerror)=='function')?onerror:null;this.onprogress=(onprogress&&typeof(onprogress)=='function')?onprogress:null;this.onresource=(onresource&&typeof(onresource)=='function')?onresource:null;this.requestCount=0;this.requests=[];};JSC3D.ObjLoader.prototype.loadFromUrl=function(urlName){var urlPath='';var fileName=urlName;var lastSlashAt=urlName.lastIndexOf('/');if(lastSlashAt==-1)
lastSlashAt=urlName.lastIndexOf('\\');if(lastSlashAt!=-1){urlPath=urlName.substring(0,lastSlashAt+1);fileName=urlName.substring(lastSlashAt+1);}
this.requestCount=0;this.loadObjFile(urlPath,fileName);};JSC3D.ObjLoader.prototype.abort=function(){for(var i=0;i<this.requests.length;i++){this.requests[i].abort();}
this.requests=[];this.requestCount=0;};JSC3D.ObjLoader.prototype.loadObjFile=function(urlPath,fileName){var urlName=urlPath+fileName;var self=this;var xhr=new XMLHttpRequest;xhr.open('GET',urlName,true);xhr.onreadystatechange=function(){if(this.readyState==4){if(this.status==200||this.status==0){if(self.onload){if(self.onprogress)
self.onprogress('Loading 3D model file ...',1);if(JSC3D.console)
JSC3D.console.logInfo('Finished loading 3D model file "'+urlName+'".');var scene=new JSC3D.Scene;var mtllibs=self.parseObj(scene,this.responseText);if(mtllibs.length>0){for(var i=0;i<mtllibs.length;i++)
self.loadMtlFile(scene,urlPath,mtllibs[i]);}
self.requests.splice(self.requests.indexOf(this),1);if(--self.requestCount==0)
self.onload(scene);}}
else{self.requests.splice(self.requests.indexOf(this),1);self.requestCount--;if(JSC3D.console)
JSC3D.console.logError('Failed to load 3D model file "'+urlName+'".');if(self.onerror)
self.onerror('Failed to load obj file "'+urlName+'".');}}};if(this.onprogress){this.onprogress('Loading 3D model file ...',0);xhr.onprogress=function(event){self.onprogress('Loading 3D model file ...',event.position/event.totalSize);};}
this.requests.push(xhr);this.requestCount++;xhr.send();};JSC3D.ObjLoader.prototype.loadMtlFile=function(scene,urlPath,fileName){var urlName=urlPath+fileName;var self=this;var xhr=new XMLHttpRequest;xhr.open('GET',urlName,true);xhr.onreadystatechange=function(){if(this.readyState==4){if(this.status==200||this.status==0){if(self.onprogress)
self.onprogress('Loading 3D model file (2/2) ...',1);if(JSC3D.console)
JSC3D.console.logInfo('Finished loading 3D model file (2/2)"'+urlName+'".');var mtls=self.parseMtl(this.responseText);var textures={};var meshes=scene.getChildren();for(var i=0;i<meshes.length;i++){var mesh=meshes[i];if(mesh.mtl!=null&&mesh.mtllib!=null&&mesh.mtllib==fileName){var mtl=mtls[mesh.mtl];if(mtl!=null){if(mtl.material!=null)
mesh.setMaterial(mtl.material);if(mtl.textureFileName!=''){if(!textures[mtl.textureFileName])
textures[mtl.textureFileName]=[mesh];else
textures[mtl.textureFileName].push(mesh);}}}}
for(var textureFileName in textures)
self.setupTexture(textures[textureFileName],urlPath+textureFileName);}
else{if(JSC3D.console)
JSC3D.console.logWarning('Failed to load 3D model file (2/2) "'+urlName+'". A default material will be applied.');}
self.requests.splice(self.requests.indexOf(this),1);if(--self.requestCount==0)
self.onload(scene);}};if(this.onprogress){this.onprogress('Loading 3D model file (2/2) ...',0);xhr.onprogress=function(event){self.onprogress('Loading 3D model file (2/2) ...',event.position/event.totalSize);};}
this.requests.push(xhr);this.requestCount++;xhr.send();};JSC3D.ObjLoader.prototype.parseObj=function(scene,data){var meshes={};var mtllibs=[];var namePrefix='obj-';var meshIndex=0;var curMesh=null;var curMtllibName='';var curMtlName='';var tempVertexBuffer=[];var tempTexCoordBuffer=[];var defaultMeshName=namePrefix+meshIndex++;var defaultMesh=new JSC3D.Mesh;defaultMesh.name=defaultMeshName;defaultMesh.indexBuffer=[];meshes['nomtl']=defaultMesh;curMesh=defaultMesh;var lines=data.split(/[ \t]*\r?\n[ \t]*/);for(var i=0;i<lines.length;i++){var line=lines[i];var tokens=line.split(/[ \t]+/);if(tokens.length>0){var keyword=tokens[0];switch(keyword){case'v':if(tokens.length>3){for(var j=1;j<4;j++){tempVertexBuffer.push(parseFloat(tokens[j]));}}
break;case'vn':break;case'vt':if(tokens.length>2){tempTexCoordBuffer.push(parseFloat(tokens[1]));tempTexCoordBuffer.push(1-parseFloat(tokens[2]));}
break;case'f':if(tokens.length>3){for(var j=1;j<tokens.length;j++){var refs=tokens[j].split('/');var index=parseInt(refs[0])-1;curMesh.indexBuffer.push(index);if(refs.length>1){if(refs[1]!=''){if(!curMesh.texCoordIndexBuffer)
curMesh.texCoordIndexBuffer=[];curMesh.texCoordIndexBuffer.push(parseInt(refs[1])-1);}
else if(refs.length<3||refs[2]==''){if(!curMesh.texCoordIndexBuffer)
curMesh.texCoordIndexBuffer=[];curMesh.texCoordIndexBuffer.push(index);}}}
curMesh.indexBuffer.push(-1);if(curMesh.texCoordIndexBuffer)
curMesh.texCoordIndexBuffer.push(-1);}
break;case'mtllib':if(tokens.length>1){curMtllibName=tokens[1];mtllibs.push(curMtllibName);}
else
curMtllibName='';break;case'usemtl':if(tokens.length>1&&tokens[1]!=''&&curMtllibName!=''){curMtlName=tokens[1];var meshid=curMtllibName+'-'+curMtlName;var mesh=meshes[meshid];if(!mesh){mesh=new JSC3D.Mesh;mesh.name=namePrefix+meshIndex++;mesh.indexBuffer=[];mesh.mtllib=curMtllibName;mesh.mtl=curMtlName;meshes[meshid]=mesh;}
curMesh=mesh;}
else{curMtlName='';curMesh=defaultMesh;}
break;var JSC3D=JSC3D||{};(function(window,undefined){'use strict';var Hammer=function(element,options){return new Hammer.Instance(element,options||{});};Hammer.defaults={stop_browser_behavior:{userSelect:'none',touchAction:'none',touchCallout:'none',contentZooming:'none',userDrag:'none',tapHighlightColor:'rgba(0,0,0,0)'}};Hammer.HAS_POINTEREVENTS=navigator.pointerEnabled||navigator.msPointerEnabled;Hammer.HAS_TOUCHEVENTS=('ontouchstart'in window);Hammer.MOBILE_REGEX=/mobile|tablet|ip(ad|hone|od)|android/i;Hammer.NO_MOUSEEVENTS=Hammer.HAS_TOUCHEVENTS&&navigator.userAgent.match(Hammer.MOBILE_REGEX);Hammer.EVENT_TYPES={};Hammer.DIRECTION_DOWN='down';Hammer.DIRECTION_LEFT='left';Hammer.DIRECTION_UP='up';Hammer.DIRECTION_RIGHT='right';Hammer.POINTER_MOUSE='mouse';Hammer.POINTER_TOUCH='touch';Hammer.POINTER_PEN='pen';Hammer.EVENT_START='start';Hammer.EVENT_MOVE='move';Hammer.EVENT_END='end';Hammer.DOCUMENT=document;Hammer.plugins={};Hammer.READY=false;function setup(){if(Hammer.READY){return;}
Hammer.event.determineEventTypes();for(var name in Hammer.gestures){if(Hammer.gestures.hasOwnProperty(name)){Hammer.detection.register(Hammer.gestures[name]);}}
Hammer.event.onTouch(Hammer.DOCUMENT,Hammer.EVENT_MOVE,Hammer.detection.detect);Hammer.event.onTouch(Hammer.DOCUMENT,Hammer.EVENT_END,Hammer.detection.detect);Hammer.READY=true;}
Hammer.Instance=function(element,options){var self=this;setup();this.element=element;this.enabled=true;this.options=Hammer.utils.extend(Hammer.utils.extend({},Hammer.defaults),options||{});if(this.options.stop_browser_behavior){Hammer.utils.stopDefaultBrowserBehavior(this.element,this.options.stop_browser_behavior);}
Hammer.event.onTouch(element,Hammer.EVENT_START,function(ev){if(self.enabled){Hammer.detection.startDetect(self,ev);}});return this;};Hammer.Instance.prototype={on:function onEvent(gesture,handler){var gestures=gesture.split(' ');for(var t=0;t<gestures.length;t++){this.element.addEventListener(gestures[t],handler,false);}
return this;},off:function offEvent(gesture,handler){var gestures=gesture.split(' ');for(var t=0;t<gestures.length;t++){this.element.removeEventListener(gestures[t],handler,false);}
return this;},trigger:function triggerEvent(gesture,eventData){var event=Hammer.DOCUMENT.createEvent('Event');event.initEvent(gesture,true,true);event.gesture=eventData;var element=this.element;if(Hammer.utils.hasParent(eventData.target,element)){element=eventData.target;}
element.dispatchEvent(event);return this;},enable:function enable(state){this.enabled=state;return this;}};var last_move_event=null;var enable_detect=false;var touch_triggered=false;Hammer.event={bindDom:function(element,type,handler){var types=type.split(' ');for(var t=0;t<types.length;t++){element.addEventListener(types[t],handler,false);}},onTouch:function onTouch(element,eventType,handler){var self=this;this.bindDom(element,Hammer.EVENT_TYPES[eventType],function bindDomOnTouch(ev){var sourceEventType=ev.type.toLowerCase();if(sourceEventType.match(/mouse/)&&touch_triggered){return;}
else if(sourceEventType.match(/touch/)||sourceEventType.match(/pointerdown/)||(sourceEventType.match(/mouse/)&&ev.which===1)){enable_detect=true;}
if(sourceEventType.match(/touch|pointer/)){touch_triggered=true;}
var count_touches=0;if(enable_detect){if(Hammer.HAS_POINTEREVENTS&&eventType!=Hammer.EVENT_END){count_touches=Hammer.PointerEvent.updatePointer(eventType,ev);}
else if(sourceEventType.match(/touch/)){count_touches=ev.touches.length;}
else if(!touch_triggered){count_touches=sourceEventType.match(/up/)?0:1;}
if(count_touches>0&&eventType==Hammer.EVENT_END){eventType=Hammer.EVENT_MOVE;}
else if(!count_touches){eventType=Hammer.EVENT_END;}
if(!count_touches&&last_move_event!==null){ev=last_move_event;}
else{last_move_event=ev;}
handler.call(Hammer.detection,self.collectEventData(element,eventType,ev));if(Hammer.HAS_POINTEREVENTS&&eventType==Hammer.EVENT_END){count_touches=Hammer.PointerEvent.updatePointer(eventType,ev);}}
if(!count_touches){last_move_event=null;enable_detect=false;touch_triggered=false;Hammer.PointerEvent.reset();}});},determineEventTypes:function determineEventTypes(){var types;if(Hammer.HAS_POINTEREVENTS){types=Hammer.PointerEvent.getEvents();}
else if(Hammer.NO_MOUSEEVENTS){types=['touchstart','touchmove','touchend touchcancel'];}
else{types=['touchstart mousedown','touchmove mousemove','touchend touchcancel mouseup'];}
Hammer.EVENT_TYPES[Hammer.EVENT_START]=types[0];Hammer.EVENT_TYPES[Hammer.EVENT_MOVE]=types[1];Hammer.EVENT_TYPES[Hammer.EVENT_END]=types[2];},getTouchList:function getTouchList(ev){if(Hammer.HAS_POINTEREVENTS){return Hammer.PointerEvent.getTouchList();}
else if(ev.touches){return ev.touches;}
else{return[{identifier:1,pageX:ev.pageX,pageY:ev.pageY,target:ev.target}];}},collectEventData:function collectEventData(element,eventType,ev){var touches=this.getTouchList(ev,eventType);var pointerType=Hammer.POINTER_TOUCH;if(ev.type.match(/mouse/)||Hammer.PointerEvent.matchType(Hammer.POINTER_MOUSE,ev)){pointerType=Hammer.POINTER_MOUSE;}
return{center:Hammer.utils.getCenter(touches),timeStamp:new Date().getTime(),target:ev.target,touches:touches,eventType:eventType,pointerType:pointerType,srcEvent:ev,preventDefault:function(){if(this.srcEvent.preventManipulation){this.srcEvent.preventManipulation();}
if(this.srcEvent.preventDefault){this.srcEvent.preventDefault();}},stopPropagation:function(){this.srcEvent.stopPropagation();},stopDetect:function(){return Hammer.detection.stopDetect();}};}};Hammer.PointerEvent={pointers:{},getTouchList:function(){var self=this;var touchlist=[];Object.keys(self.pointers).sort().forEach(function(id){touchlist.push(self.pointers[id]);});return touchlist;},updatePointer:function(type,pointerEvent){if(type==Hammer.EVENT_END){this.pointers={};}
else{pointerEvent.identifier=pointerEvent.pointerId;this.pointers[pointerEvent.pointerId]=pointerEvent;}
return Object.keys(this.pointers).length;},matchType:function(pointerType,ev){if(!ev.pointerType){return false;}
var types={};types[Hammer.POINTER_MOUSE]=(ev.pointerType==ev.MSPOINTER_TYPE_MOUSE||ev.pointerType==Hammer.POINTER_MOUSE);types[Hammer.POINTER_TOUCH]=(ev.pointerType==ev.MSPOINTER_TYPE_TOUCH||ev.pointerType==Hammer.POINTER_TOUCH);types[Hammer.POINTER_PEN]=(ev.pointerType==ev.MSPOINTER_TYPE_PEN||ev.pointerType==Hammer.POINTER_PEN);return types[pointerType];},getEvents:function(){return['pointerdown MSPointerDown','pointermove MSPointerMove','pointerup pointercancel MSPointerUp MSPointerCancel'];},reset:function(){this.pointers={};}};Hammer.utils={extend:function extend(dest,src,merge){for(var key in src){if(dest[key]!==undefined&&merge){continue;}
dest[key]=src[key];}
return dest;},hasParent:function(node,parent){while(node){if(node==parent){return true;}
node=node.parentNode;}
return false;},getCenter:function getCenter(touches){var valuesX=[],valuesY=[];for(var t=0,len=touches.length;t<len;t++){valuesX.push(touches[t].pageX);valuesY.push(touches[t].pageY);}
return{pageX:((Math.min.apply(Math,valuesX)+Math.max.apply(Math,valuesX))/2),pageY:((Math.min.apply(Math,valuesY)+Math.max.apply(Math,valuesY))/2)};},getVelocity:function getVelocity(delta_time,delta_x,delta_y){return{x:Math.abs(delta_x/delta_time)||0,y:Math.abs(delta_y/delta_time)||0};},getAngle:function getAngle(touch1,touch2){var y=touch2.pageY-touch1.pageY,x=touch2.pageX-touch1.pageX;return Math.atan2(y,x)*180/Math.PI;},getDirection:function getDirection(touch1,touch2){var x=Math.abs(touch1.pageX-touch2.pageX),y=Math.abs(touch1.pageY-touch2.pageY);if(x>=y){return touch1.pageX-touch2.pageX>0?Hammer.DIRECTION_LEFT:Hammer.DIRECTION_RIGHT;}
else{return touch1.pageY-touch2.pageY>0?Hammer.DIRECTION_UP:Hammer.DIRECTION_DOWN;}},getDistance:function getDistance(touch1,touch2){var x=touch2.pageX-touch1.pageX,y=touch2.pageY-touch1.pageY;return Math.sqrt((x*x)+(y*y));},getScale:function getScale(start,end){if(start.length>=2&&end.length>=2){return this.getDistance(end[0],end[1])/this.getDistance(start[0],start[1]);}
return 1;},getRotation:function getRotation(start,end){if(start.length>=2&&end.length>=2){return this.getAngle(end[1],end[0])-
this.getAngle(start[1],start[0]);}
return 0;},isVertical:function isVertical(direction){return(direction==Hammer.DIRECTION_UP||direction==Hammer.DIRECTION_DOWN);},stopDefaultBrowserBehavior:function stopDefaultBrowserBehavior(element,css_props){var prop,vendors=['webkit','khtml','moz','ms','o',''];if(!css_props||!element.style){return;}
for(var i=0;i<vendors.length;i++){for(var p in css_props){if(css_props.hasOwnProperty(p)){prop=p;if(vendors[i]){prop=vendors[i]+prop.substring(0,1).toUpperCase()+prop.substring(1);}
element.style[prop]=css_props[p];}}}
if(css_props.userSelect=='none'){element.onselectstart=function(){return false;};}}};Hammer.detection={gestures:[],current:null,previous:null,stopped:false,startDetect:function startDetect(inst,eventData){if(this.current){return;}
this.stopped=false;this.current={inst:inst,startEvent:Hammer.utils.extend({},eventData),lastEvent:false,name:''};this.detect(eventData);},detect:function detect(eventData){if(!this.current||this.stopped){return;}
eventData=this.extendEventData(eventData);var inst_options=this.current.inst.options;for(var g=0,len=this.gestures.length;g<len;g++){var gesture=this.gestures[g];if(!this.stopped&&inst_options[gesture.name]!==false){if(gesture.handler.call(gesture,eventData,this.current.inst)===false){this.stopDetect();break;}}}
if(this.current){this.current.lastEvent=eventData;}
if(eventData.eventType==Hammer.EVENT_END&&!eventData.touches.length-1){this.stopDetect();}
return eventData;},stopDetect:function stopDetect(){this.previous=Hammer.utils.extend({},this.current);this.current=null;this.stopped=true;},extendEventData:function extendEventData(ev){var startEv=this.current.startEvent;if(startEv&&(ev.touches.length!=startEv.touches.length||ev.touches===startEv.touches)){startEv.touches=[];for(var i=0,len=ev.touches.length;i<len;i++){startEv.touches.push(Hammer.utils.extend({},ev.touches[i]));}}
var delta_time=ev.timeStamp-startEv.timeStamp,delta_x=ev.center.pageX-startEv.center.pageX,delta_y=ev.center.pageY-startEv.center.pageY,velocity=Hammer.utils.getVelocity(delta_time,delta_x,delta_y);Hammer.utils.extend(ev,{deltaTime:delta_time,deltaX:delta_x,deltaY:delta_y,velocityX:velocity.x,velocityY:velocity.y,distance:Hammer.utils.getDistance(startEv.center,ev.center),angle:Hammer.utils.getAngle(startEv.center,ev.center),direction:Hammer.utils.getDirection(startEv.center,ev.center),scale:Hammer.utils.getScale(startEv.touches,ev.touches),rotation:Hammer.utils.getRotation(startEv.touches,ev.touches),startEvent:startEv});return ev;},register:function register(gesture){var options=gesture.defaults||{};if(options[gesture.name]===undefined){options[gesture.name]=true;}
Hammer.utils.extend(Hammer.defaults,options,true);gesture.index=gesture.index||1000;this.gestures.push(gesture);this.gestures.sort(function(a,b){if(a.index<b.index){return-1;}
if(a.index>b.index){return 1;}
return 0;});return this.gestures;}};Hammer.gestures=Hammer.gestures||{};Hammer.gestures.Hold={name:'hold',index:10,defaults:{hold_timeout:500,hold_threshold:1},timer:null,handler:function holdGesture(ev,inst){switch(ev.eventType){case Hammer.EVENT_START:clearTimeout(this.timer);Hammer.detection.current.name=this.name;this.timer=setTimeout(function(){if(Hammer.detection.current.name=='hold'){inst.trigger('hold',ev);}},inst.options.hold_timeout);break;case Hammer.EVENT_MOVE:if(ev.distance>inst.options.hold_threshold){clearTimeout(this.timer);}
break;case Hammer.EVENT_END:clearTimeout(this.timer);break;}}};Hammer.gestures.Tap={name:'tap',index:100,defaults:{tap_max_touchtime:250,tap_max_distance:10,tap_always:true,doubletap_distance:20,doubletap_interval:300},handler:function tapGesture(ev,inst){if(ev.eventType==Hammer.EVENT_END){var prev=Hammer.detection.previous,did_doubletap=false;if(ev.deltaTime>inst.options.tap_max_touchtime||ev.distance>inst.options.tap_max_distance){return;}
if(prev&&prev.name=='tap'&&(ev.timeStamp-prev.lastEvent.timeStamp)<inst.options.doubletap_interval&&ev.distance<inst.options.doubletap_distance){inst.trigger('doubletap',ev);did_doubletap=true;}
if(!did_doubletap||inst.options.tap_always){Hammer.detection.current.name='tap';inst.trigger(Hammer.detection.current.name,ev);}}}};Hammer.gestures.Swipe={name:'swipe',index:40,defaults:{swipe_max_touches:1,swipe_velocity:0.7},handler:function swipeGesture(ev,inst){if(ev.eventType==Hammer.EVENT_END){if(inst.options.swipe_max_touches>0&&ev.touches.length>inst.options.swipe_max_touches){return;}
if(ev.velocityX>inst.options.swipe_velocity||ev.velocityY>inst.options.swipe_velocity){inst.trigger(this.name,ev);inst.trigger(this.name+ev.direction,ev);}}}};Hammer.gestures.Drag={name:'drag',index:50,defaults:{drag_min_distance:10,drag_max_touches:1,drag_block_horizontal:false,drag_block_vertical:false,drag_lock_to_axis:false,drag_lock_min_distance:25},triggered:false,handler:function dragGesture(ev,inst){if(Hammer.detection.current.name!=this.name&&this.triggered){inst.trigger(this.name+'end',ev);this.triggered=false;return;}
if(inst.options.drag_max_touches>0&&ev.touches.length>inst.options.drag_max_touches){return;}
switch(ev.eventType){case Hammer.EVENT_START:this.triggered=false;break;case Hammer.EVENT_MOVE:if(ev.distance<inst.options.drag_min_distance&&Hammer.detection.current.name!=this.name){return;}
Hammer.detection.current.name=this.name;if(Hammer.detection.current.lastEvent.drag_locked_to_axis||(inst.options.drag_lock_to_axis&&inst.options.drag_lock_min_distance<=ev.distance)){ev.drag_locked_to_axis=true;}
var last_direction=Hammer.detection.current.lastEvent.direction;if(ev.drag_locked_to_axis&&last_direction!==ev.direction){if(Hammer.utils.isVertical(last_direction)){ev.direction=(ev.deltaY<0)?Hammer.DIRECTION_UP:Hammer.DIRECTION_DOWN;}
else{ev.direction=(ev.deltaX<0)?Hammer.DIRECTION_LEFT:Hammer.DIRECTION_RIGHT;}}
if(!this.triggered){inst.trigger(this.name+'start',ev);this.triggered=true;}
inst.trigger(this.name,ev);inst.trigger(this.name+ev.direction,ev);if((inst.options.drag_block_vertical&&Hammer.utils.isVertical(ev.direction))||(inst.options.drag_block_horizontal&&!Hammer.utils.isVertical(ev.direction))){ev.preventDefault();}
break;case Hammer.EVENT_END:if(this.triggered){inst.trigger(this.name+'end',ev);}
this.triggered=false;break;}}};Hammer.gestures.Transform={name:'transform',index:45,defaults:{transform_min_scale:0.01,transform_min_rotation:1,transform_always_block:false},triggered:false,handler:function transformGesture(ev,inst){if(Hammer.detection.current.name!=this.name&&this.triggered){inst.trigger(this.name+'end',ev);this.triggered=false;return;}
if(ev.touches.length<2){return;}
if(inst.options.transform_always_block){ev.preventDefault();}
switch(ev.eventType){case Hammer.EVENT_START:this.triggered=false;break;case Hammer.EVENT_MOVE:var scale_threshold=Math.abs(1-ev.scale);var rotation_threshold=Math.abs(ev.rotation);if(scale_threshold<inst.options.transform_min_scale&&rotation_threshold<inst.options.transform_min_rotation){return;}
Hammer.detection.current.name=this.name;if(!this.triggered){inst.trigger(this.name+'start',ev);this.triggered=true;}
inst.trigger(this.name,ev);if(rotation_threshold>inst.options.transform_min_rotation){inst.trigger('rotate',ev);}
if(scale_threshold>inst.options.transform_min_scale){inst.trigger('pinch',ev);inst.trigger('pinch'+((ev.scale<1)?'in':'out'),ev);}
break;case Hammer.EVENT_END:if(this.triggered){inst.trigger(this.name+'end',ev);}
this.triggered=false;break;}}};Hammer.gestures.Touch={name:'touch',index:-Infinity,defaults:{prevent_default:false,prevent_mouseevents:false},handler:function touchGesture(ev,inst){if(inst.options.prevent_mouseevents&&ev.pointerType==Hammer.POINTER_MOUSE){ev.stopDetect();return;}
if(inst.options.prevent_default){ev.preventDefault();}
if(ev.eventType==Hammer.EVENT_START){inst.trigger(this.name,ev);}}};Hammer.gestures.Release={name:'release',index:Infinity,handler:function releaseGesture(ev,inst){if(ev.eventType==Hammer.EVENT_END){inst.trigger(this.name,ev);}}};if(typeof module==='object'&&typeof module.exports==='object'){module.exports=Hammer;}
else{window.Hammer=Hammer;if(typeof window.define==='function'&&window.define.amd){window.define('hammer',[],function(){return Hammer;});}}})(JSC3D);var JSC3D=JSC3D||{};JSC3D.WebGLRenderBackend=function(canvas,releaseLocalBuffers){this.canvas=canvas;this.isIE11=(JSC3D.PlatformInfo.browser=='ie')&&(parseInt(JSC3D.PlatformInfo.version)>=11);this.gl=canvas.getContext('experimental-webgl',{preserveDrawingBuffer:true})||canvas.getContext('webgl');if(!this.gl)
throw'JSC3D.WebGLRenderBackend constructor failed: Cannot get WebGL context!';this.definition='standard';this.bkgColors=[0,0];this.bkgTexture=null;this.backFB=null;this.pickingFB=null;this.pickingResult=new Uint8Array(4);this.releaseLocalBuffers=releaseLocalBuffers||false;this.screen_vs='#ifdef GL_ES \n'+'	precision mediump float; \n'+'#endif	\n'+'\n'+'attribute vec2 a_position; \n'+'varying vec2 v_texCoord; \n'+'\n'+'void main(void) { \n'+'	v_texCoord = vec2(0.5, 0.5) * a_position + vec2(0.5, 0.5); \n'+'	gl_Position = vec4(a_position, 1.0, 1.0); \n'+'}';this.screen_fs='#ifdef GL_ES \n'+'	precision mediump float; \n'+'#endif	\n'+'\n'+'uniform sampler2D s_screenTexture; \n'+'varying vec2 v_texCoord; \n'+'\n'+'void main(void) { \n'+'	gl_FragColor = texture2D(s_screenTexture, v_texCoord); \n'+'}';this.gradient_background_vs='#ifdef GL_ES \n'+'	precision mediump float; \n'+'#endif	\n'+'\n'+'uniform vec3 u_color1; \n'+'uniform vec3 u_color2; \n'+'attribute vec2 a_position; \n'+'varying vec4 v_color; \n'+'\n'+'void main(void) { \n'+'	v_color = vec4(a_position.y > 0.0 ? u_color1 : u_color2, 1.0); \n'+'	gl_Position = vec4(a_position, 1.0, 1.0); \n'+'}';this.gradient_background_fs='#ifdef GL_ES \n'+'	precision mediump float; \n'+'#endif	\n'+'\n'+'varying vec4 v_color; \n'+'\n'+'void main(void) { \n'+'	gl_FragColor = v_color;'+'}';this.frame_vs='#ifdef GL_ES \n'+'	precision mediump float; \n'+'#endif	\n'+'\n'+'uniform bool u_isPoint; \n'+'uniform mat4 u_transformMatrix; \n'+'attribute vec3 a_position; \n'+'\n'+'void main(void) { \n'+'	if(u_isPoint) { \n'+'		gl_PointSize = 2.0; \n'+'	} \n'+'	gl_Position = u_transformMatrix * vec4(a_position, 1.0); \n'+'}';this.frame_fs='#ifdef GL_ES \n'+'	precision mediump float; \n'+'#endif	\n'+'\n'+'uniform vec3 u_materialColor; \n'+'\n'+'void main(void) { \n'+'	gl_FragColor = vec4(u_materialColor, 1.0); \n'+'}';this.solid_vs='#ifdef GL_ES \n'+'	precision mediump float; \n'+'#endif	\n'+'\n'+'uniform bool u_isLit; \n'+'uniform bool u_isCast; \n'+'uniform bool u_hasTexture; \n'+'uniform mat3 u_rotationMatrix; \n'+'uniform mat4 u_transformMatrix; \n'+'attribute vec3 a_position; \n'+'attribute vec3 a_normal; \n'+'attribute vec2 a_texCoord; \n'+'varying vec3 v_normal; \n'+'varying vec2 v_texCoord; \n'+'\n'+'void main(void) { \n'+'	if(u_isLit) { \n'+'		v_normal = u_rotationMatrix * a_normal; \n'+'	} \n'+'	if(u_hasTexture) { \n'+'		v_texCoord = a_texCoord; \n'+'	} \n'+'	gl_Position = u_transformMatrix * vec4(a_position, 1.0); \n'+'}';this.solid_fs='#ifdef GL_ES \n'+'	precision mediump float; \n'+'#endif	\n'+'\n'+'uniform bool  u_isLit; \n'+'uniform bool  u_isCast; \n'+'uniform bool  u_hasTexture; \n'+'uniform float u_opacity; \n'+'uniform sampler2D s_palette; \n'+'uniform sampler2D s_texture; \n'+'uniform sampler2D s_sphereTexture; \n'+'varying vec3 v_normal; \n'+'varying vec2 v_texCoord; \n'+'\n'+'void main(void) { \n'+'	vec4 materialColor = u_isLit ? vec4(texture2D(s_palette, vec2(abs(v_normal.z), 0.0)).rgb, u_opacity) : vec4(1.0, 1.0, 1.0, u_opacity); \n'+'	if(u_isCast) { \n'+'		gl_FragColor = materialColor * texture2D(s_sphereTexture, vec2(0.5, -0.5) * v_normal.xy + vec2(0.5, 0.5)); \n'+'	} \n'+'	else { \n'+'		gl_FragColor = u_hasTexture ? (materialColor * texture2D(s_texture, v_texCoord)) : materialColor; \n'+'	} \n'+'}';this.picking_vs='#ifdef GL_ES \n'+'	precision mediump float; \n'+'#endif	\n'+'\n'+'uniform mat4 u_transformMatrix; \n'+'attribute vec3 a_position; \n'+'\n'+'void main(void) { \n'+'	gl_Position = u_transformMatrix * vec4(a_position, 1.0); \n'+'}';this.picking_fs='#ifdef GL_ES \n'+'	precision mediump float; \n'+'#endif	\n'+'\n'+'uniform vec3 u_pickingId; \n'+'\n'+'void main(void) { \n'+'	gl_FragColor = vec4(u_pickingId, 1.0); \n'+'}';function createProgram(gl,vSrc,fSrc){var vShader=gl.createShader(gl.VERTEX_SHADER);gl.shaderSource(vShader,vSrc);gl.compileShader(vShader);if(!gl.getShaderParameter(vShader,gl.COMPILE_STATUS)){if(JSC3D.console)
JSC3D.console.logWarning('Error occured in shader compilation: '+gl.getShaderInfoLog(vShader)+' The corresponding program will be ignored.');return null;}
var fShader=gl.createShader(gl.FRAGMENT_SHADER);gl.shaderSource(fShader,fSrc);gl.compileShader(fShader);if(!gl.getShaderParameter(fShader,gl.COMPILE_STATUS)){if(JSC3D.console)
JSC3D.console.logWarning('Error occured in shader compilation: '+gl.getShaderInfoLog(fShader)+' The corresponding program will be ignored.');return null;}
var program=gl.createProgram();gl.attachShader(program,vShader);gl.attachShader(program,fShader);gl.linkProgram(program);if(!gl.getProgramParameter(program,gl.LINK_STATUS)){if(JSC3D.console)
JSC3D.console.logWarning('Error occured when generating program: '+gl.getProgramInfoLog(program)+' This program will be ignored.');return null;}
program.attributes={};var numOfAttribs=gl.getProgramParameter(program,gl.ACTIVE_ATTRIBUTES);for(var i=0;i<numOfAttribs;i++){var attrib=gl.getActiveAttrib(program,i);program.attributes[attrib.name]=gl.getAttribLocation(program,attrib.name);}
program.uniforms={};var numOfUniforms=gl.getProgramParameter(program,gl.ACTIVE_UNIFORMS);for(var i=0;i<numOfUniforms;i++){var uniform=gl.getActiveUniform(program,i);program.uniforms[uniform.name]=gl.getUniformLocation(program,uniform.name);}
return program;}
this.programs={screen:createProgram(this.gl,this.screen_vs,this.screen_fs),gradient_background:createProgram(this.gl,this.gradient_background_vs,this.gradient_background_fs),frame:createProgram(this.gl,this.frame_vs,this.frame_fs),solid:createProgram(this.gl,this.solid_vs,this.solid_fs),picking:createProgram(this.gl,this.picking_vs,this.picking_fs)};this.canvasBoard=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.canvasBoard);this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,1,1,1,1,-1,1,-1,-1]),this.gl.STATIC_DRAW);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null);};JSC3D.WebGLRenderBackend.prototype.setBackgroundColors=function(color1,color2){this.bkgColors=[new Float32Array([(color1&0xff0000)/16777216,(color1&0xff00)/65536,(color1&0xff)/256])];if(color1!=color2)
this.bkgColors.push(new Float32Array([(color2&0xff0000)/16777216,(color2&0xff00)/65536,(color2&0xff)/256]));};JSC3D.WebGLRenderBackend.prototype.setBackgroundImage=function(img){var gl=this.gl;this.bkgTexture=gl.createTexture();gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,true);gl.bindTexture(gl.TEXTURE_2D,this.bkgTexture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,img);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.bindTexture(gl.TEXTURE_2D,null);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,false);};JSC3D.WebGLRenderBackend.prototype.beginFrame=function(definition){var gl=this.gl;function prepareFB(gl,fbo,w,h){gl.bindFramebuffer(gl.FRAMEBUFFER,fbo);var depthAttachment=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,depthAttachment);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,w,h);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,depthAttachment);gl.bindRenderbuffer(gl.RENDERBUFFER,null);var colorAttachment=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,colorAttachment);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,colorAttachment,0);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,w,h,0,gl.RGBA,gl.UNSIGNED_BYTE,null);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.bindTexture(gl.TEXTURE_2D,null);fbo.width=w;fbo.height=h;fbo.texture=colorAttachment;fbo.depthRB=depthAttachment;}
function destroyFB(gl,fbo){gl.deleteRenderbuffer(fbo.depthRB);gl.deleteTexture(fbo.texture);gl.deleteFramebuffer(fbo);}
if(!this.pickingFB){this.pickingFB=gl.createFramebuffer();prepareFB(gl,this.pickingFB,this.canvas.width,this.canvas.height);gl.bindFramebuffer(gl.FRAMEBUFFER,null);}
var frameWidth=this.canvas.width;var frameHeight=this.canvas.height;switch(definition){case'low':frameWidth=frameWidth>>1;frameHeight=frameHeight>>1;break;case'high':frameWidth*=2;frameHeight*=2;break;case'standard':default:break;}
if(frameWidth!=this.canvas.width){if(!this.backFB){this.backFB=gl.createFramebuffer();prepareFB(gl,this.backFB,frameWidth,frameHeight);}
else if(this.definition!=definition){prepareFB(gl,this.backFB,frameWidth,frameHeight);}
else{gl.bindFramebuffer(gl.FRAMEBUFFER,this.backFB);}}
else if(this.backFB){destroyFB(gl,this.backFB);this.backFB=null;}
this.definition=definition;gl.viewport(0,0,frameWidth,frameHeight);if(this.bkgTexture){gl.frontFace(gl.CCW);gl.disable(gl.DEPTH_TEST);gl.clear(gl.DEPTH_BUFFER_BIT);gl.useProgram(this.programs.screen);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,this.bkgTexture);gl.uniform1i(this.programs.screen.uniforms['s_screenTexture'],0);gl.enableVertexAttribArray(0);gl.bindBuffer(gl.ARRAY_BUFFER,this.canvasBoard);gl.vertexAttribPointer(0,2,gl.FLOAT,false,0,0);gl.drawArrays(gl.TRIANGLES,0,6);gl.bindBuffer(gl.ARRAY_BUFFER,null);gl.bindTexture(gl.TEXTURE_2D,null);}
else if(this.bkgColors.length>1){gl.frontFace(gl.CCW);gl.disable(gl.DEPTH_TEST);gl.clear(gl.DEPTH_BUFFER_BIT);gl.useProgram(this.programs.gradient_background);gl.uniform3fv(this.programs.gradient_background.uniforms['u_color1'],this.bkgColors[0]);gl.uniform3fv(this.programs.gradient_background.uniforms['u_color2'],this.bkgColors[1]);gl.enableVertexAttribArray(0);gl.bindBuffer(gl.ARRAY_BUFFER,this.canvasBoard);gl.vertexAttribPointer(0,2,gl.FLOAT,false,0,0);gl.drawArrays(gl.TRIANGLES,0,6);gl.bindBuffer(gl.ARRAY_BUFFER,null);}
else{var color=this.bkgColors[0];gl.clearColor(color[0],color[1],color[2],1);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);}};JSC3D.WebGLRenderBackend.prototype.endFrame=function(){var gl=this.gl;gl.bindFramebuffer(gl.FRAMEBUFFER,null);switch(this.definition){case'low':case'high':if(this.backFB){gl.viewport(0,0,this.canvas.width,this.canvas.height);gl.frontFace(gl.CCW);gl.disable(gl.DEPTH_TEST);gl.useProgram(this.programs.screen);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,this.backFB.texture);gl.uniform1i(this.programs.screen.uniforms['s_screenTexture'],0);gl.enableVertexAttribArray(0);gl.bindBuffer(gl.ARRAY_BUFFER,this.canvasBoard);gl.vertexAttribPointer(0,2,gl.FLOAT,false,0,0);gl.drawArrays(gl.TRIANGLES,0,6);gl.bindBuffer(gl.ARRAY_BUFFER,null);gl.bindTexture(gl.TEXTURE_2D,null);}
break;case'standard':default:break;}
gl.flush();};JSC3D.WebGLRenderBackend.prototype.render=function(renderList,transformMatrix,normalMatrix,renderMode,defaultMaterial,sphereMap){var gl=this.gl;var transformMat4Flattened=new Float32Array([transformMatrix.m00,transformMatrix.m10,transformMatrix.m20,0,transformMatrix.m01,transformMatrix.m11,transformMatrix.m21,0,transformMatrix.m02,transformMatrix.m12,transformMatrix.m22,0,transformMatrix.m03,transformMatrix.m13,transformMatrix.m23,1]);var normalMat3Flattened=new Float32Array([normalMatrix.m00,normalMatrix.m10,normalMatrix.m20,normalMatrix.m01,normalMatrix.m11,normalMatrix.m21,normalMatrix.m02,normalMatrix.m12,normalMatrix.m22]);this.renderColorPass(renderList,transformMat4Flattened,normalMat3Flattened,renderMode,defaultMaterial,sphereMap);if(this.pickingFB){gl.bindFramebuffer(gl.FRAMEBUFFER,this.pickingFB);this.renderPickingPass(renderList,transformMat4Flattened,defaultMaterial);gl.bindFramebuffer(gl.FRAMEBUFFER,null);}};JSC3D.WebGLRenderBackend.prototype.pick=function(x,y){if(!this.pickingFB)
return 0;var gl=this.gl;gl.bindFramebuffer(gl.FRAMEBUFFER,this.pickingFB);gl.readPixels(x,this.pickingFB.height-y,1,1,gl.RGBA,gl.UNSIGNED_BYTE,this.pickingResult);gl.bindFramebuffer(gl.FRAMEBUFFER,null);return this.pickingResult[0]<<16|this.pickingResult[1]<<8|this.pickingResult[2];};JSC3D.WebGLRenderBackend.prototype.renderColorPass=function(renderList,transformMat4,normalMat3,renderMode,defaultMaterial,sphereMap){if(sphereMap&&sphereMap.hasData()&&!sphereMap.compiled)
this.compileTexture(sphereMap);var gl=this.gl;gl.disable(gl.BLEND);gl.enable(gl.DEPTH_TEST);gl.depthMask(true);gl.frontFace(gl.CCW);var curProgram=null;var isBlendEnabled=false;for(var i=0;i<renderList.length;i++){var mesh=renderList[i];if(mesh.isTrivial()||!mesh.visible)
continue;var material=mesh.material||defaultMaterial;var texture=mesh.hasTexture()?mesh.texture:null;var isTransparent=(material.transparency>0)||(texture&&texture.hasTransparency);var opacity=1-material.transparency;if(!material.compiled)
this.compileMaterial(material);if(texture&&!texture.compiled)
this.compileTexture(texture);if(mesh.isDoubleSided)
gl.disable(gl.CULL_FACE);else
gl.enable(gl.CULL_FACE);if(isTransparent!=isBlendEnabled){if(isTransparent){gl.depthMask(false);gl.enable(gl.BLEND);gl.blendFuncSeparate(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA,gl.ONE,gl.ONE);}
else{gl.depthMask(true);gl.disable(gl.BLEND);}
isBlendEnabled=isTransparent;}
var isSphereMapped=mesh.isEnvironmentCast&&(sphereMap!=null);var rmode=mesh.renderMode||renderMode;var program;switch(rmode){case'point':case'wireframe':program=this.programs.frame;break;case'flat':case'smooth':program=this.programs.solid;break;case'texture':case'textureflat':if(!texture)
rmode='flat';program=this.programs.solid;break;case'texturesmooth':if(!texture&&!isSphereMapped)
rmode='smooth';program=this.programs.solid;break;default:rmode='flat';program=this.programs.solid;break;}
if(!mesh.compiled||mesh.compiled.remderMode!=rmode)
this.compileMesh(mesh,rmode);if(curProgram!=program){gl.useProgram(program);curProgram=program;}
switch(rmode){case'point':gl.uniform1i(program.uniforms['u_isPoint'],rmode=='point');gl.uniform3fv(program.uniforms['u_materialColor'],material.compiled.diffColor);gl.uniformMatrix4fv(program.uniforms['u_transformMatrix'],false,transformMat4);gl.enableVertexAttribArray(program.attributes['a_position']);gl.bindBuffer(gl.ARRAY_BUFFER,mesh.compiled.coords);gl.vertexAttribPointer(program.attributes['a_position'],3,gl.FLOAT,false,0,0);gl.drawArrays(gl.POINTS,0,mesh.compiled.coordCount);break;case'wireframe':break;case'flat':case'smooth':gl.uniform1i(program.uniforms['u_isLit'],true);gl.uniform1i(program.uniforms['u_isCast'],false);gl.uniform1i(program.uniforms['u_hasTexture'],false);gl.uniform1f(program.uniforms['u_opacity'],opacity);gl.uniformMatrix3fv(program.uniforms['u_rotationMatrix'],false,normalMat3);gl.uniformMatrix4fv(program.uniforms['u_transformMatrix'],false,transformMat4);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,material.compiled.palette);gl.uniform1i(program.uniforms['s_palette'],0);gl.enableVertexAttribArray(program.attributes['a_position']);gl.bindBuffer(gl.ARRAY_BUFFER,mesh.compiled.coords);gl.vertexAttribPointer(program.attributes['a_position'],3,gl.FLOAT,false,0,0);gl.enableVertexAttribArray(program.attributes['a_normal']);gl.bindBuffer(gl.ARRAY_BUFFER,mesh.compiled.normals);gl.vertexAttribPointer(program.attributes['a_normal'],3,gl.FLOAT,false,0,0);gl.disableVertexAttribArray(program.attributes['a_texCoord']);gl.drawArrays(gl.TRIANGLES,0,mesh.compiled.coordCount);break;case'texture':gl.uniform1i(program.uniforms['u_isLit'],false);gl.uniform1i(program.uniforms['u_isCast'],false);gl.uniform1i(program.uniforms['u_hasTexture'],true);gl.uniform1f(program.uniforms['u_opacity'],opacity);gl.uniformMatrix3fv(program.uniforms['u_rotationMatrix'],false,normalMat3);gl.uniformMatrix4fv(program.uniforms['u_transformMatrix'],false,transformMat4);gl.activeTexture(gl.TEXTURE1);gl.bindTexture(gl.TEXTURE_2D,texture.compiled.tex);gl.uniform1i(program.uniforms['s_texture'],1);gl.enableVertexAttribArray(program.attributes['a_position']);gl.bindBuffer(gl.ARRAY_BUFFER,mesh.compiled.coords);gl.vertexAttribPointer(program.attributes['a_position'],3,gl.FLOAT,false,0,0);gl.disableVertexAttribArray(program.attributes['a_normal']);gl.enableVertexAttribArray(program.attributes['a_texCoord']);gl.bindBuffer(gl.ARRAY_BUFFER,mesh.compiled.texcoords);gl.vertexAttribPointer(program.attributes['a_texCoord'],2,gl.FLOAT,false,0,0);gl.drawArrays(gl.TRIANGLES,0,mesh.compiled.coordCount);break;case'textureflat':gl.uniform1i(program.uniforms['u_isLit'],true);gl.uniform1i(program.uniforms['u_isCast'],false);gl.uniform1i(program.uniforms['u_hasTexture'],true);gl.uniform1f(program.uniforms['u_opacity'],opacity);gl.uniformMatrix3fv(program.uniforms['u_rotationMatrix'],false,normalMat3);gl.uniformMatrix4fv(program.uniforms['u_transformMatrix'],false,transformMat4);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,material.compiled.palette);gl.uniform1i(program.uniforms['s_palette'],0);gl.activeTexture(gl.TEXTURE1);gl.bindTexture(gl.TEXTURE_2D,texture.compiled.tex);gl.uniform1i(program.uniforms['s_texture'],1);gl.enableVertexAttribArray(program.attributes['a_position']);gl.bindBuffer(gl.ARRAY_BUFFER,mesh.compiled.coords);gl.vertexAttribPointer(program.attributes['a_position'],3,gl.FLOAT,false,0,0);gl.enableVertexAttribArray(program.attributes['a_normal']);gl.bindBuffer(gl.ARRAY_BUFFER,mesh.compiled.normals);gl.vertexAttribPointer(program.attributes['a_normal'],3,gl.FLOAT,false,0,0);gl.enableVertexAttribArray(program.attributes['a_texCoord']);gl.bindBuffer(gl.ARRAY_BUFFER,mesh.compiled.texcoords);gl.vertexAttribPointer(program.attributes['a_texCoord'],2,gl.FLOAT,false,0,0);gl.drawArrays(gl.TRIANGLES,0,mesh.compiled.coordCount);break;case'texturesmooth':gl.uniform1i(program.uniforms['u_isLit'],true);gl.uniform1i(program.uniforms['u_isCast'],isSphereMapped);gl.uniform1i(program.uniforms['u_hasTexture'],!isSphereMapped);gl.uniform1f(program.uniforms['u_opacity'],opacity);gl.uniformMatrix3fv(program.uniforms['u_rotationMatrix'],false,normalMat3);gl.uniformMatrix4fv(program.uniforms['u_transformMatrix'],false,transformMat4);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,material.compiled.palette);gl.uniform1i(program.uniforms['s_palette'],0);if(!isSphereMapped){gl.activeTexture(gl.TEXTURE1);gl.bindTexture(gl.TEXTURE_2D,texture.compiled.tex);gl.uniform1i(program.uniforms['s_texture'],1);}
else{gl.activeTexture(gl.TEXTURE2);gl.bindTexture(gl.TEXTURE_2D,sphereMap.compiled.tex);gl.uniform1i(program.uniforms['s_sphereTexture'],2);}
gl.enableVertexAttribArray(program.attributes['a_position']);gl.bindBuffer(gl.ARRAY_BUFFER,mesh.compiled.coords);gl.vertexAttribPointer(program.attributes['a_position'],3,gl.FLOAT,false,0,0);gl.enableVertexAttribArray(program.attributes['a_normal']);gl.bindBuffer(gl.ARRAY_BUFFER,mesh.compiled.normals);gl.vertexAttribPointer(program.attributes['a_normal'],3,gl.FLOAT,false,0,0);if(!isSphereMapped){gl.enableVertexAttribArray(program.attributes['a_texCoord']);gl.bindBuffer(gl.ARRAY_BUFFER,mesh.compiled.texcoords);gl.vertexAttribPointer(program.attributes['a_texCoord'],2,gl.FLOAT,false,0,0);}
else
gl.disableVertexAttribArray(program.attributes['a_texCoord']);gl.drawArrays(gl.TRIANGLES,0,mesh.compiled.coordCount);break;default:break;}}};JSC3D.WebGLRenderBackend.prototype.renderPickingPass=function(renderList,transformMat4,defaultMaterial){var gl=this.gl;gl.disable(gl.BLEND);gl.enable(gl.DEPTH_TEST);gl.depthMask(true);gl.frontFace(gl.CCW);gl.viewport(0,0,this.pickingFB.width,this.pickingFB.height);gl.clearColor(0,0,0,1);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);gl.useProgram(this.programs.picking);for(var i=0;i<renderList.length;i++){var mesh=renderList[i];if(mesh.isTrivial()||!mesh.visible)
continue;var material=mesh.material||defaultMaterial;if(material.transparency>0.99)
continue;if(mesh.isDoubleSided)
gl.disable(gl.CULL_FACE);else
gl.enable(gl.CULL_FACE);gl.uniformMatrix4fv(this.programs.picking.uniforms['u_transformMatrix'],false,transformMat4);gl.uniform3fv(this.programs.picking.uniforms['u_pickingId'],mesh.compiled.pickingId);gl.enableVertexAttribArray(this.programs.picking.attributes['a_position']);gl.bindBuffer(gl.ARRAY_BUFFER,mesh.compiled.coords);gl.vertexAttribPointer(this.programs.picking.attributes['a_position'],3,gl.FLOAT,false,0,0);switch(mesh.compiled.remderMode){case'point':gl.drawArrays(gl.POINTS,0,mesh.compiled.coordCount);break;case'wireframe':break;case'flat':case'smooth':case'texture':case'textureflat':case'texturesmooth':default:gl.drawArrays(gl.TRIANGLES,0,mesh.compiled.coordCount);break;}}};JSC3D.WebGLRenderBackend.prototype.compileMesh=function(mesh,renderMode){if(mesh.isTrivial())
return false;renderMode=mesh.renderMode||renderMode;var gl=this.gl;var needFlat=(renderMode=='flat')||(renderMode=='textureflat');var hasTrianglesOnly=mesh.indexBuffer.length==4*mesh.faceCount;var hasTextureCoords=mesh.texCoordBuffer&&mesh.texCoordBuffer.length>=2;var ibuf=mesh.indexBuffer;var vbuf=mesh.vertexBuffer;var tbuf=mesh.texCoordBuffer;var tibuf=mesh.texCoordIndexBuffer||ibuf;var nbuf=mesh.vertexNormalBuffer;var nibuf=mesh.vertexNormalIndexBuffer||ibuf;var fnbuf=mesh.faceNormalBuffer;var numOfFaces=mesh.faceCount;if(!mesh.compiled){mesh.compiled={isIndexed:false};mesh.compiled.pickingId=new Float32Array([(mesh.internalId&0xff0000)/16777216,(mesh.internalId&0xff00)/65536,(mesh.internalId&0xff)/256]);var triangles,edges,coords,normals,texcoords;if(hasTrianglesOnly){coords=new Float32Array(9*numOfFaces);normals=new Float32Array(9*numOfFaces);if(hasTextureCoords)
texcoords=new Float32Array(6*numOfFaces);var v0,v1,v2;var n0,n1,n2;var t0,t1,t2;for(var i=0,j=0,k=0,faceIndex=0;i<ibuf.length;i+=4,j+=9,k+=6,faceIndex++){v0=ibuf[i]*3;v1=ibuf[i+1]*3;v2=ibuf[i+2]*3;coords[j]=vbuf[v0];coords[j+1]=vbuf[v0+1];coords[j+2]=vbuf[v0+2];coords[j+3]=vbuf[v1];coords[j+4]=vbuf[v1+1];coords[j+5]=vbuf[v1+2];coords[j+6]=vbuf[v2];coords[j+7]=vbuf[v2+1];coords[j+8]=vbuf[v2+2];if(needFlat){n0=faceIndex*3;normals[j]=normals[j+3]=normals[j+6]=fnbuf[n0];normals[j+1]=normals[j+4]=normals[j+7]=fnbuf[n0+1];normals[j+2]=normals[j+5]=normals[j+8]=fnbuf[n0+2];}
else{n0=nibuf[i]*3;n1=nibuf[i+1]*3;n2=nibuf[i+2]*3;normals[j]=nbuf[n0];normals[j+1]=nbuf[n0+1];normals[j+2]=nbuf[n0+2];normals[j+3]=nbuf[n1];normals[j+4]=nbuf[n1+1];normals[j+5]=nbuf[n1+2];normals[j+6]=nbuf[n2];normals[j+7]=nbuf[n2+1];normals[j+8]=nbuf[n2+2];}
if(hasTextureCoords){t0=tibuf[i]*2;t1=tibuf[i+1]*2;t2=tibuf[i+2]*2;texcoords[k]=tbuf[t0];texcoords[k+1]=tbuf[t0+1];texcoords[k+2]=tbuf[t1];texcoords[k+3]=tbuf[t1+1];texcoords[k+4]=tbuf[t2];texcoords[k+5]=tbuf[t2+1];}}}
else{coords=[];normals=[];if(hasTextureCoords)
texcoords=[];var v0,v1,v2;var n0,n1,n2;var t0,t1,t2;for(var i=0,j=0;i<numOfFaces;i++){v0=ibuf[j]*3;v1=ibuf[j+1]*3;n0=nibuf[j]*3;n1=nibuf[j+1]*3;if(hasTextureCoords){t0=tibuf[j]*2;t1=tibuf[j+1]*2;}
j+=2;while(ibuf[j]>=0){v2=ibuf[j]*3;coords.push(vbuf[v0],vbuf[v0+1],vbuf[v0+2],vbuf[v1],vbuf[v1+1],vbuf[v1+2],vbuf[v2],vbuf[v2+1],vbuf[v2+2]);v1=v2;if(needFlat){n0=i*3;normals.push(fnbuf[n0],fnbuf[n0+1],fnbuf[n0+2],fnbuf[n0],fnbuf[n0+1],fnbuf[n0+2],fnbuf[n0],fnbuf[n0+1],fnbuf[n0+2]);}
else{n2=nibuf[j]*3;normals.push(nbuf[n0],nbuf[n0+1],nbuf[n0+2],nbuf[n1],nbuf[n1+1],nbuf[n1+2],nbuf[n2],nbuf[n2+1],nbuf[n2+2]);n1=n2;}
if(hasTextureCoords){t2=tibuf[j]*2;texcoords.push(tbuf[t0],tbuf[t0+1],tbuf[t1],tbuf[t1+1],tbuf[t2],tbuf[t2+1]);t1=t2;}
j++;}
j++;}
coords=new Float32Array(coords);normals=new Float32Array(normals);if(hasTextureCoords)
texcoords=new Float32Array(texcoords);}
mesh.compiled.coords=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,mesh.compiled.coords);gl.bufferData(gl.ARRAY_BUFFER,coords,gl.STATIC_DRAW);mesh.compiled.normals=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,mesh.compiled.normals);gl.bufferData(gl.ARRAY_BUFFER,normals,gl.STATIC_DRAW);if(hasTextureCoords){mesh.compiled.texcoords=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,mesh.compiled.texcoords);gl.bufferData(gl.ARRAY_BUFFER,texcoords,gl.STATIC_DRAW);}
gl.bindBuffer(gl.ARRAY_BUFFER,null);mesh.compiled.faceCount=numOfFaces;mesh.compiled.coordCount=coords.length/3;}
else{var isFlat=(mesh.compiled.remderMode=='flat')||(mesh.compiled.remderMode=='textureflat');if(isFlat!=needFlat){var normals;if(hasTrianglesOnly){normals=new Float32Array(9*numOfFaces);var n0,n1,n2
for(var i=0,j=0,faceIndex=0;i<ibuf.length;i+=4,j+=9,faceIndex++){if(needFlat){n0=faceIndex*3;normals[j]=normals[j+3]=normals[j+6]=fnbuf[n0];normals[j+1]=normals[j+4]=normals[j+7]=fnbuf[n0+1];normals[j+2]=normals[j+5]=normals[j+8]=fnbuf[n0+2];}
else{n0=nibuf[i]*3;n1=nibuf[i+1]*3;n2=nibuf[i+2]*3;normals[j]=nbuf[n0];normals[j+1]=nbuf[n0+1];normals[j+2]=nbuf[n0+2];normals[j+3]=nbuf[n1];normals[j+4]=nbuf[n1+1];normals[j+5]=nbuf[n1+2];normals[j+6]=nbuf[n2];normals[j+7]=nbuf[n2+1];normals[j+8]=nbuf[n2+2];}}}
else{normals=[];var n0,n1,n2;for(var i=0,j=0;i<numOfFaces;i++){n0=nibuf[j++]*3;n1=nibuf[j++]*3;while(ibuf[j]>=0){if(needFlat){n0=i*3;normals.push(fnbuf[n0],fnbuf[n0+1],fnbuf[n0+2],fnbuf[n0],fnbuf[n0+1],fnbuf[n0+2],fnbuf[n0],fnbuf[n0+1],fnbuf[n0+2]);}
else{n2=nibuf[j]*3;normals.push(nbuf[n0],nbuf[n0+1],nbuf[n0+2],nbuf[n1],nbuf[n1+1],nbuf[n1+2],nbuf[n2],nbuf[n2+1],nbuf[n2+2]);n1=n2;}
j++;}
j++;}
normals=new Float32Array(normals);}
if(this.isIE11){gl.deleteBuffer(mesh.compiled.normals);mesh.compiled.normals=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,mesh.compiled.normals);gl.bufferData(gl.ARRAY_BUFFER,normals,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,null);}
else{gl.bindBuffer(gl.ARRAY_BUFFER,mesh.compiled.normals);gl.bufferSubData(gl.ARRAY_BUFFER,0,normals);gl.bindBuffer(gl.ARRAY_BUFFER,null);}}}
mesh.compiled.remderMode=renderMode;return true;};JSC3D.WebGLRenderBackend.prototype.compileMaterial=function(material){var gl=this.gl;material.compiled={diffColor:new Float32Array([(material.diffuseColor&0xff0000)/16777216,(material.diffuseColor&0xff00)/65536,(material.diffuseColor&0xff)/256])};var rgba=new Uint8Array((new Uint32Array(material.getPalette())).buffer);for(var i=0;i<rgba.length;i+=4){var tmp=rgba[i];rgba[i]=rgba[i+2];rgba[i+2]=tmp;}
material.compiled.palette=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,material.compiled.palette);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,256,1,0,gl.RGBA,gl.UNSIGNED_BYTE,rgba);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.bindTexture(gl.TEXTURE_2D,null);return true;};JSC3D.WebGLRenderBackend.prototype.compileTexture=function(texture,genMipmap){if(!texture.hasData())
return false;genMipmap=genMipmap||texture.hasMipmap();var gl=this.gl;texture.compiled={hasMipmap:genMipmap};var rgba=new Uint8Array((new Uint32Array(texture.data)).buffer);for(var i=0;i<rgba.length;i+=4){var tmp=rgba[i];rgba[i]=rgba[i+2];rgba[i+2]=tmp;}
texture.compiled.tex=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,texture.compiled.tex);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,texture.width,texture.height,0,gl.RGBA,gl.UNSIGNED_BYTE,rgba);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,genMipmap?gl.LINEAR_MIPMAP_NEAREST:gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.REPEAT);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.REPEAT);if(genMipmap)
gl.generateMipmap(gl.TEXTURE_2D);gl.bindTexture(gl.TEXTURE_2D,null);return true;};